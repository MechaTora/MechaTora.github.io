<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç CSVÁîªÂÉèÊ§úÁ¥¢&Ëá™Âãï‰øùÂ≠ò„ÉÑ„Éº„É´</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .header p {
            color: #6c757d;
            font-size: 1.1rem;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .upload-section {
            text-align: center;
            padding: 40px;
            border: 2px dashed #667eea;
            border-radius: 15px;
            background: rgba(102, 126, 234, 0.05);
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-item {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .setting-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }

        .log-section {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #17a2b8;
        }

        .log-warning {
            color: #ffc107;
        }

        .csv-preview {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .csv-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .csv-table th,
        .csv-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .csv-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .csv-table tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .results-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-5px);
        }

        .result-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .result-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .result-status {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .processing {
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideIn 0.5s ease-out;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç CSVÁîªÂÉèÊ§úÁ¥¢&Ëá™Âãï‰øùÂ≠ò„ÉÑ„Éº„É´</h1>
            <p>CSV„Éï„Ç°„Ç§„É´„ÅÆAÂàó„ÅÆÊñáÂ≠ó„ÅßÁîªÂÉè„ÇíÊ§úÁ¥¢„Åó„ÄÅËá™ÂãïÁöÑ„Å´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éª‰øùÂ≠ò„Åó„Åæ„Åô</p>
        </div>

        <div class="main-panel">
            <div class="upload-section" onclick="document.getElementById('csvFile').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">üìÅ</div>
                <h3>CSV„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h3>
                <p>„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû</p>
                <small>AÂàó„Å´Ê§úÁ¥¢„Åó„Åü„ÅÑÊñáÂ≠óÂàó„ÅåÂÖ•„Å£„ÅüCSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
                <div style="margin-top: 15px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; color: #155724;">
                    üíæ <strong>‰øùÂ≠òÂÖà:</strong> „ÄåÁîªÂÉè‰øùÂ≠òÂÖà„Äç„Éï„Ç©„É´„ÉÄ„Å´Ëá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô
                </div>
            </div>
            <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="handleCSVUpload(event)">

            <div class="csv-preview" id="csvPreview">
                <h3>üìä CSV„Éó„É¨„Éì„É•„Éº</h3>
                <div id="csvTable"></div>
                <p style="margin-top: 15px; color: #6c757d;">
                    <strong>Ê§úÂá∫„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„ÉâÊï∞:</strong> <span id="keywordCount">0</span>
                </p>
            </div>

            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">üîç Ê§úÁ¥¢„Ç®„É≥„Ç∏„É≥</div>
                    <select class="form-select" id="searchEngine">
                        <option value="unsplash">Unsplash (È´òÂìÅË≥™ÂÜôÁúü)</option>
                        <option value="pixabay">Pixabay (ÁÑ°ÊñôÁîªÂÉè)</option>
                        <option value="pexels">Pexels („Éó„É≠ÂìÅË≥™)</option>
                    </select>
                </div>

                <div class="setting-item">
                    <div class="setting-label">üìê ÁîªÂÉè„Çµ„Ç§„Ç∫</div>
                    <select class="form-select" id="imageSize">
                        <option value="small">Â∞è (640x640)</option>
                        <option value="medium" selected>‰∏≠ (1280x1280)</option>
                        <option value="large">Â§ß (1920x1920)</option>
                    </select>
                </div>

                <div class="setting-item">
                    <div class="setting-label">‚è±Ô∏è Ê§úÁ¥¢ÈñìÈöî (Áßí)</div>
                    <input type="number" class="form-input" id="searchDelay" value="2" min="1" max="10">
                </div>

                <div class="setting-item">
                    <div class="setting-label">üì∏ ÊúÄÂ§ßÂèñÂæóÊï∞/„Ç≠„Éº„ÉØ„Éº„Éâ</div>
                    <input type="number" class="form-input" id="maxImages" value="1" min="1" max="5">
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" id="startBtn" onclick="startImageSearch()" disabled>
                    üöÄ ÁîªÂÉèÊ§úÁ¥¢ÈñãÂßã
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopImageSearch()" style="display: none;">
                    ‚èπÔ∏è ÂÅúÊ≠¢
                </button>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <h3>üìà ÈÄ≤ÊçóÁä∂Ê≥Å</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Ê∫ñÂÇô‰∏≠...</div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalKeywords">0</div>
                    <div class="stat-label">Á∑è„Ç≠„Éº„ÉØ„Éº„ÉâÊï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="processedKeywords">0</div>
                    <div class="stat-label">Âá¶ÁêÜÊ∏à„Åø</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successfulDownloads">0</div>
                    <div class="stat-label">ÊàêÂäü„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="errorCount">0</div>
                    <div class="stat-label">„Ç®„É©„ÉºÊï∞</div>
                </div>
            </div>

            <div class="log-section" id="logSection">
                <div class="log-entry log-info">üìã „É≠„Ç∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô...</div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <h3>üñºÔ∏è Ê§úÁ¥¢ÁµêÊûú</h3>
            <div class="results-grid" id="resultsGrid"></div>
        </div>
    </div>

    <script>
        class ImageSearcher {
            constructor() {
                this.csvData = [];
                this.keywords = [];
                this.currentIndex = 0;
                this.isProcessing = false;
                this.results = [];
                this.stats = {
                    total: 0,
                    processed: 0,
                    successful: 0,
                    errors: 0
                };
            }

            // CSVÂá¶ÁêÜ
            parseCSV(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim());
                const data = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const columns = this.parseCSVLine(line);
                        if (columns.length > 0 && columns[0].trim()) {
                            data.push(columns);
                        }
                    }
                }
                
                return data;
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result.map(item => item.replace(/^"|"$/g, '').trim());
            }

            // CSVË°®Á§∫
            displayCSVPreview() {
                const preview = document.getElementById('csvPreview');
                const tableContainer = document.getElementById('csvTable');
                
                if (this.csvData.length === 0) {
                    preview.style.display = 'none';
                    return;
                }

                let tableHTML = '<table class="csv-table"><thead><tr>';
                
                // „Éò„ÉÉ„ÉÄ„Éº‰ΩúÊàê
                const maxColumns = Math.max(...this.csvData.map(row => row.length));
                for (let i = 0; i < maxColumns; i++) {
                    tableHTML += `<th>${String.fromCharCode(65 + i)}Âàó</th>`;
                }
                tableHTML += '</tr></thead><tbody>';

                // „Éá„Éº„ÇøË°å‰ΩúÊàêÔºàÊúÄÂàù„ÅÆ10Ë°å„Åæ„ÅßË°®Á§∫Ôºâ
                const displayRows = Math.min(10, this.csvData.length);
                for (let i = 0; i < displayRows; i++) {
                    tableHTML += '<tr>';
                    for (let j = 0; j < maxColumns; j++) {
                        const cellData = this.csvData[i][j] || '';
                        const isKeyword = j === 0 && cellData.trim() !== '';
                        tableHTML += `<td style="${isKeyword ? 'background: rgba(102, 126, 234, 0.2); font-weight: bold;' : ''}">${cellData}</td>`;
                    }
                    tableHTML += '</tr>';
                }
                
                if (this.csvData.length > 10) {
                    tableHTML += `<tr><td colspan="${maxColumns}" style="text-align: center; color: #6c757d; font-style: italic;">... ‰ªñ ${this.csvData.length - 10} Ë°å</td></tr>`;
                }
                
                tableHTML += '</tbody></table>';
                tableContainer.innerHTML = tableHTML;
                
                // „Ç≠„Éº„ÉØ„Éº„ÉâÊäΩÂá∫
                this.keywords = this.csvData
                    .map(row => row[0])
                    .filter(keyword => keyword && keyword.trim() !== '')
                    .map(keyword => keyword.trim());
                
                document.getElementById('keywordCount').textContent = this.keywords.length;
                document.getElementById('startBtn').disabled = this.keywords.length === 0;
                
                preview.style.display = 'block';
                preview.classList.add('fade-in');
            }

            // ÁîªÂÉèÊ§úÁ¥¢
            async searchImages(keyword, engine, size, maxCount) {
                this.addLog(`üîç "${keyword}" „ÇíÊ§úÁ¥¢‰∏≠...`, 'info');
                
                try {
                    let images = [];
                    
                    if (engine === 'unsplash') {
                        images = await this.searchUnsplash(keyword, size, maxCount);
                    } else if (engine === 'pixabay') {
                        images = await this.searchPixabay(keyword, size, maxCount);
                    } else if (engine === 'pexels') {
                        images = await this.searchPexels(keyword, size, maxCount);
                    }
                    
                    if (images.length > 0) {
                        this.addLog(`‚úÖ "${keyword}" „ÅÆÁîªÂÉè ${images.length} ‰ª∂„ÇíÂèñÂæó`, 'success');
                    } else {
                        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å®„Åó„Å¶„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁîªÂÉè„Çí‰ΩøÁî®
                        images = await this.getPlaceholderImages(keyword, size, maxCount);
                        this.addLog(`‚ö†Ô∏è "${keyword}" „ÅÆÊ§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁîªÂÉè„Çí‰ΩøÁî®`, 'warning');
                    }
                    
                    return images;
                } catch (error) {
                    this.addLog(`‚ùå "${keyword}" „ÅÆÊ§úÁ¥¢„Å´Â§±Êïó: ${error.message}`, 'error');
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å®„Åó„Å¶„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁîªÂÉè„ÇíËøî„Åô
                    return await this.getPlaceholderImages(keyword, size, maxCount);
                }
            }

            // UnsplashÊ§úÁ¥¢ÔºàÁÑ°Êñô„Éó„É©„É≥„ÅÆÂà∂Èôê„Å´Ê≥®ÊÑèÔºâ
            async searchUnsplash(keyword, size, maxCount) {
                const images = [];
                
                // ÁÑ°Êñô„Ç¢„ÇØ„Çª„Çπ„ÅÆ„Åü„ÇÅ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Çí‰ΩøÁî®
                for (let i = 0; i < maxCount; i++) {
                    const width = size === 'small' ? 640 : size === 'medium' ? 1280 : 1920;
                    const height = width;
                    const imageUrl = `https://source.unsplash.com/${width}x${height}/?${encodeURIComponent(keyword)}&${Date.now()}-${i}`;
                    
                    images.push({
                        url: imageUrl,
                        filename: `${this.sanitizeFilename(keyword)}_unsplash_${i + 1}.jpg`,
                        size: size
                    });
                }
                
                return images;
            }

            // PixabayÊ§úÁ¥¢Ôºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂÆüË£ÖÔºâ
            async searchPixabay(keyword, size, maxCount) {
                return await this.getPlaceholderImages(keyword, size, maxCount, 'pixabay');
            }

            // PexelsÊ§úÁ¥¢Ôºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂÆüË£ÖÔºâ
            async searchPexels(keyword, size, maxCount) {
                return await this.getPlaceholderImages(keyword, size, maxCount, 'pexels');
            }

            // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁîªÂÉèÂèñÂæó
            async getPlaceholderImages(keyword, size, maxCount, source = 'picsum') {
                const images = [];
                
                for (let i = 0; i < maxCount; i++) {
                    const width = size === 'small' ? 640 : size === 'medium' ? 1280 : 1920;
                    const height = width;
                    const imageUrl = `https://picsum.photos/${width}/${height}?random=${Date.now()}-${i}&keyword=${encodeURIComponent(keyword)}`;
                    
                    images.push({
                        url: imageUrl,
                        filename: `${this.sanitizeFilename(keyword)}_${source}_${i + 1}.jpg`,
                        size: size
                    });
                }
                
                return images;
            }

            // „Éï„Ç°„Ç§„É´Âêç„Çí„Çµ„Éã„Çø„Ç§„Ç∫
            sanitizeFilename(filename) {
                return filename
                    .replace(/[<>:"/\\|?*]/g, '_')  // ÁÑ°Âäπ„Å™ÊñáÂ≠ó„ÇíÁΩÆÊèõ
                    .replace(/\s+/g, '_')           // „Çπ„Éö„Éº„Çπ„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´
                    .replace(/[^\w\-_.]/g, '_')     // Ëã±Êï∞Â≠ó„ÄÅ„Éè„Ç§„Éï„É≥„ÄÅ„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÄÅ„Éî„É™„Ç™„Éâ‰ª•Â§ñ„ÇíÁΩÆÊèõ
                    .substring(0, 50);              // Èï∑„ÅïÂà∂Èôê
            }

            // ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            async downloadImage(imageData, keyword) {
                try {
                    this.addLog(`üíæ "${imageData.filename}" „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠...`, 'info');
                    
                    // ÂÆüÈöõ„Å´ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                    const response = await fetch(imageData.url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const blob = await response.blob();
                    
                    // ÁîªÂÉè‰øùÂ≠òÂÖà„Éï„Ç©„É´„ÉÄ„Å´‰øùÂ≠ò
                    this.saveFile(blob, imageData.filename);
                    
                    this.addLog(`‚úÖ "${imageData.filename}" „ÇíÁîªÂÉè‰øùÂ≠òÂÖà„Éï„Ç©„É´„ÉÄ„Å´‰øùÂ≠òÂÆå‰∫Ü`, 'success');
                    
                    return {
                        keyword: keyword,
                        filename: imageData.filename,
                        url: imageData.url,
                        status: 'success'
                    };
                } catch (error) {
                    this.addLog(`‚ùå "${imageData.filename}" „ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó: ${error.message}`, 'error');
                    throw error;
                }
            }

            // „Éï„Ç°„Ç§„É´‰øùÂ≠òÔºà„ÄåÁîªÂÉè‰øùÂ≠òÂÖà„Äç„Éï„Ç©„É´„ÉÄ„Å´‰øùÂ≠òÔºâ
            saveFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ÁîªÂÉè‰øùÂ≠òÂÖà/${filename}`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // „É°„Ç§„É≥Âá¶ÁêÜ
            async startProcessing() {
                if (this.isProcessing || this.keywords.length === 0) return;
                
                this.isProcessing = true;
                this.currentIndex = 0;
                this.results = [];
                this.stats = {
                    total: this.keywords.length,
                    processed: 0,
                    successful: 0,
                    errors: 0
                };
                
                this.showProgressSection();
                this.updateStats();
                this.updateProgress();
                
                const engine = document.getElementById('searchEngine').value;
                const size = document.getElementById('imageSize').value;
                const maxImages = parseInt(document.getElementById('maxImages').value);
                const delay = parseInt(document.getElementById('searchDelay').value) * 1000;
                
                this.addLog(`üöÄ Âá¶ÁêÜÈñãÂßã: ${this.keywords.length} „Ç≠„Éº„ÉØ„Éº„Éâ`, 'info');
                
                for (let i = 0; i < this.keywords.length && this.isProcessing; i++) {
                    const keyword = this.keywords[i];
                    this.currentIndex = i;
                    
                    try {
                        this.updateProgress();
                        
                        // ÁîªÂÉèÊ§úÁ¥¢
                        const images = await this.searchImages(keyword, engine, size, maxImages);
                        
                        // ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                        for (const imageData of images) {
                            if (!this.isProcessing) break;
                            
                            try {
                                const result = await this.downloadImage(imageData, keyword);
                                this.results.push(result);
                                this.stats.successful++;
                            } catch (error) {
                                this.results.push({
                                    keyword: keyword,
                                    filename: imageData.filename,
                                    url: imageData.url,
                                    status: 'error',
                                    error: error.message
                                });
                                this.stats.errors++;
                            }
                        }
                        
                        this.stats.processed++;
                        this.updateStats();
                        this.updateResults();
                        
                        // Ê¨°„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Åæ„ÅßÂæÖÊ©ü
                        if (i < this.keywords.length - 1 && this.isProcessing) {
                            await this.delay(delay);
                        }
                        
                    } catch (error) {
                        this.addLog(`‚ùå "${keyword}" „ÅÆÂá¶ÁêÜ„Å´Â§±Êïó: ${error.message}`, 'error');
                        this.stats.errors++;
                        this.stats.processed++;
                        this.updateStats();
                    }
                }
                
                if (this.isProcessing) {
                    this.addLog(`üéâ ÂÖ®„Å¶„ÅÆÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ`, 'success');
                    this.updateProgress(100);
                }
                
                this.isProcessing = false;
                this.updateUI();
            }

            stopProcessing() {
                this.isProcessing = false;
                this.addLog(`‚èπÔ∏è Âá¶ÁêÜ„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü`, 'warning');
                this.updateUI();
            }

            // UIÊõ¥Êñ∞
            updateProgress(customPercent = null) {
                const percent = customPercent !== null ? customPercent : 
                    this.stats.total > 0 ? Math.round((this.stats.processed / this.stats.total) * 100) : 0;
                
                document.getElementById('progressFill').style.width = `${percent}%`;
                
                if (this.isProcessing && this.currentIndex < this.keywords.length) {
                    const currentKeyword = this.keywords[this.currentIndex];
                    document.getElementById('progressText').textContent = 
                        `Âá¶ÁêÜ‰∏≠: "${currentKeyword}" (${this.stats.processed + 1}/${this.stats.total})`;
                } else if (percent === 100) {
                    document.getElementById('progressText').textContent = 'ÂÆå‰∫ÜÔºÅ';
                } else {
                    document.getElementById('progressText').textContent = 'Ê∫ñÂÇô‰∏≠...';
                }
            }

            updateStats() {
                document.getElementById('totalKeywords').textContent = this.stats.total;
                document.getElementById('processedKeywords').textContent = this.stats.processed;
                document.getElementById('successfulDownloads').textContent = this.stats.successful;
                document.getElementById('errorCount').textContent = this.stats.errors;
            }

            updateResults() {
                const grid = document.getElementById('resultsGrid');
                const resultsSection = document.getElementById('resultsSection');
                
                if (this.results.length === 0) {
                    resultsSection.style.display = 'none';
                    return;
                }
                
                grid.innerHTML = this.results.map(result => `
                    <div class="result-item">
                        ${result.status === 'success' ? 
                            `<img src="${result.url}" alt="${result.keyword}" class="result-image" loading="lazy">` :
                            `<div class="result-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;">‚ùå „Ç®„É©„Éº</div>`
                        }
                        <div class="result-name">${result.keyword}</div>
                        <div class="result-status ${result.status === 'success' ? 'status-success' : 'status-error'}">
                            ${result.status === 'success' ? '‚úÖ ÊàêÂäü' : '‚ùå Â§±Êïó'}
                        </div>
                    </div>
                `).join('');
                
                resultsSection.style.display = 'block';
            }

            updateUI() {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                if (this.isProcessing) {
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                } else {
                    startBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                }
            }

            showProgressSection() {
                const section = document.getElementById('progressSection');
                section.style.display = 'block';
                section.classList.add('fade-in');
            }

            addLog(message, type = 'info') {
                const logSection = document.getElementById('logSection');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                logSection.appendChild(logEntry);
                logSection.scrollTop = logSection.scrollHeight;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let imageSearcher;

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            imageSearcher = new ImageSearcher();
        });

        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Ë§áÊï∞„ÅÆ„Ç®„É≥„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÅßË©¶Ë°å
            tryReadWithEncoding(file, 'UTF-8')
                .then(result => {
                    if (isValidText(result)) {
                        processCSVContent(result);
                    } else {
                        return tryReadWithEncoding(file, 'Shift_JIS');
                    }
                })
                .then(result => {
                    if (result && isValidText(result)) {
                        processCSVContent(result);
                    } else {
                        return tryReadWithEncoding(file, 'UTF-16');
                    }
                })
                .then(result => {
                    if (result && isValidText(result)) {
                        processCSVContent(result);
                    } else {
                        // ÊúÄÂæå„ÅÆÊâãÊÆµ„Å®„Åó„Å¶„ÄÅ„Éê„Ç§„Éä„É™„ÅßË™≠„ÅøËæº„Çì„ÅßÊé®Ê∏¨
                        return readAsArrayBuffer(file);
                    }
                })
                .catch(error => {
                    alert('CSV„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    console.error(error);
                });
        }

        function tryReadWithEncoding(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = reject;
                
                if (encoding === 'UTF-8') {
                    reader.readAsText(file, 'UTF-8');
                } else if (encoding === 'Shift_JIS') {
                    // Shift_JIS„ÅÆ‰ª£Êõø„Å®„Åó„Å¶„ÄÅlatin1„ÅßË™≠„ÅøËæº„Çì„ÅßÂ§âÊèõ„ÇíË©¶Ë°å
                    reader.readAsText(file, 'shift_jis');
                } else if (encoding === 'UTF-16') {
                    reader.readAsText(file, 'UTF-16');
                }
            });
        }

        function readAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const bytes = new Uint8Array(arrayBuffer);
                    
                    // BOM„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) {
                        // UTF-8 BOM
                        const decoder = new TextDecoder('utf-8');
                        resolve(decoder.decode(bytes.slice(3)));
                    } else if (bytes.length >= 2 && bytes[0] === 0xFF && bytes[1] === 0xFE) {
                        // UTF-16 LE BOM
                        const decoder = new TextDecoder('utf-16le');
                        resolve(decoder.decode(bytes.slice(2)));
                    } else if (bytes.length >= 2 && bytes[0] === 0xFE && bytes[1] === 0xFF) {
                        // UTF-16 BE BOM
                        const decoder = new TextDecoder('utf-16be');
                        resolve(decoder.decode(bytes.slice(2)));
                    } else {
                        // BOM„Å™„Åó„ÄÅShift_JIS„ÅÆÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ
                        try {
                            const decoder = new TextDecoder('shift_jis');
                            resolve(decoder.decode(bytes));
                        } catch (error) {
                            // UTF-8„Åß„ÇÇË©¶Ë°å
                            const decoder = new TextDecoder('utf-8', { fatal: false });
                            resolve(decoder.decode(bytes));
                        }
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function isValidText(text) {
            // ÊñáÂ≠óÂåñ„Åë„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (!text || typeof text !== 'string') return false;
            
            // Ê•µÁ´Ø„Å´ÊñáÂ≠óÂåñ„Åë„Åó„ÅüÊñáÂ≠óÔºàÁΩÆÊèõÊñáÂ≠ó„Å™„Å©Ôºâ„ÅåÂ§ö„Åè„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const replacementCharCount = (text.match(/ÔøΩ/g) || []).length;
            const totalLength = text.length;
            
            // ÁΩÆÊèõÊñáÂ≠ó„Åå10%‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØÊñáÂ≠óÂåñ„Åë„Å®Âà§Êñ≠
            if (totalLength > 0 && (replacementCharCount / totalLength) > 0.1) {
                return false;
            }
            
            // Êó•Êú¨Ë™ûÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàCSV„Å´Êó•Êú¨Ë™û„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            const hasJapanese = /[„Å≤„Çâ„Åå„Å™„Ç´„Çø„Ç´„ÉäÊº¢Â≠ó]/.test(text) || /[„Ç°-„É∂„Éº]/.test(text) || /[‰∏Ä-ÈæØ]/.test(text);
            const hasBasicText = /[a-zA-Z0-9,\r\n]/.test(text);
            
            return hasJapanese || hasBasicText;
        }

        function processCSVContent(content) {
            try {
                imageSearcher.csvData = imageSearcher.parseCSV(content);
                imageSearcher.displayCSVPreview();
                imageSearcher.addLog(`üìÑ CSV„Éï„Ç°„Ç§„É´„ÇíÊ≠£Â∏∏„Å´Ë™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºà${imageSearcher.csvData.length}Ë°åÔºâ`, 'success');
            } catch (error) {
                alert('CSV„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                console.error(error);
            }
        }

        function startImageSearch() {
            imageSearcher.startProcessing();
        }

        function stopImageSearch() {
            imageSearcher.stopProcessing();
        }

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                const fakeEvent = { target: { files: [files[0]] } };
                handleCSVUpload(fakeEvent);
            }
        }

        // „Ç®„É≥„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ê§úÂá∫„ÇíÊîπÂñÑ„Åô„ÇãËøΩÂä†„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function detectEncoding(bytes) {
            // BOM„ÉÅ„Çß„ÉÉ„ÇØ
            if (bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) {
                return { encoding: 'utf-8', bomLength: 3 };
            }
            if (bytes.length >= 2 && bytes[0] === 0xFF && bytes[1] === 0xFE) {
                return { encoding: 'utf-16le', bomLength: 2 };
            }
            if (bytes.length >= 2 && bytes[0] === 0xFE && bytes[1] === 0xFF) {
                return { encoding: 'utf-16be', bomLength: 2 };
            }
            
            // Êó•Êú¨Ë™û„Ç®„É≥„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÅÆÊé®Ê∏¨
            let asciiCount = 0;
            let utf8Count = 0;
            let sjisCount = 0;
            
            for (let i = 0; i < Math.min(bytes.length, 1000); i++) {
                const byte = bytes[i];
                
                // ASCIIÁØÑÂõ≤
                if (byte < 0x80) {
                    asciiCount++;
                } 
                // UTF-8„Éû„É´„ÉÅ„Éê„Ç§„Éà
                else if (byte >= 0xC0 && byte <= 0xDF && i + 1 < bytes.length) {
                    const next = bytes[i + 1];
                    if (next >= 0x80 && next <= 0xBF) {
                        utf8Count++;
                        i++; // Ê¨°„ÅÆ„Éê„Ç§„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó
                    }
                }
                // Shift_JISÂÖ®ËßíÊñáÂ≠ó
                else if ((byte >= 0x81 && byte <= 0x9F) || (byte >= 0xE0 && byte <= 0xFC)) {
                    sjisCount++;
                }
            }
            
            // Êé®Ê∏¨ÁµêÊûú
            if (utf8Count > sjisCount) {
                return { encoding: 'utf-8', bomLength: 0 };
            } else if (sjisCount > 0) {
                return { encoding: 'shift_jis', bomLength: 0 };
            } else {
                return { encoding: 'utf-8', bomLength: 0 };
            }
        }
    </script>
</body>
</html>