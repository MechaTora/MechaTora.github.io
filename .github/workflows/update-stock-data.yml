 #!/usr/bin/env python3
  """
  GitHub Actionsç”¨æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  Alpha Vantage APIã‹ã‚‰æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
  """

  import requests
  import json
  import os
  import time
  from datetime import datetime, timezone, timedelta

  # Alpha Vantage APIè¨­å®š
  API_KEY = os.getenv('ALPHA_VANTAGE_API_KEY')
  BASE_URL = "https://www.alphavantage.co/query"

  # ç›£è¦–éŠ˜æŸ„ãƒªã‚¹ãƒˆ - æ—¥æœ¬æ ª25éŠ˜æŸ„ã§APIä¸Šé™500callså®Œå…¨æ´»ç”¨
  STOCKS_TO_MONITOR = {
      # ä¸»è¦æ—¥æœ¬æ ª25éŠ˜æŸ„
      "7203.T": {"name": "ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š", "country": "JP", "category": "automotive"},
      "9984.T": {"name": "ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—", "country": "JP", "category": "telecom"},
      "6758.T": {"name": "ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—", "country": "JP", "category": "electronics"},
      "9433.T": {"name": "KDDI", "country": "JP", "category": "telecom"},
      "6861.T": {"name": "ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹", "country": "JP", "category": "industrial"},
      "8035.T": {"name": "æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³", "country": "JP", "category": "tech"},
      "4755.T": {"name": "æ¥½å¤©ã‚°ãƒ«ãƒ¼ãƒ—", "country": "JP", "category": "ecommerce"},
      "4502.T": {"name": "æ­¦ç”°è–¬å“å·¥æ¥­", "country": "JP", "category": "pharma"},
      "8001.T": {"name": "ä¼Šè—¤å¿ å•†äº‹", "country": "JP", "category": "trading"},
      "7974.T": {"name": "ä»»å¤©å ‚", "country": "JP", "category": "gaming"},
      "8766.T": {"name": "æ±äº¬æµ·ä¸Šãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹", "country": "JP", "category": "finance"},
      "9020.T": {"name": "æ±æ—¥æœ¬æ—…å®¢é‰„é“", "country": "JP", "category": "transport"},
      "4568.T": {"name": "ç¬¬ä¸€ä¸‰å…±", "country": "JP", "category": "pharma"},
      "6098.T": {"name": "ãƒªã‚¯ãƒ«ãƒ¼ãƒˆãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹", "country": "JP", "category": "services"},
      "8058.T": {"name": "ä¸‰è±å•†äº‹", "country": "JP", "category": "trading"},
      "6954.T": {"name": "ãƒ•ã‚¡ãƒŠãƒƒã‚¯", "country": "JP", "category": "industrial"},
      "9432.T": {"name": "æ—¥æœ¬é›»ä¿¡é›»è©±", "country": "JP", "category": "telecom"},
      "4063.T": {"name": "ä¿¡è¶ŠåŒ–å­¦å·¥æ¥­", "country": "JP", "category": "chemicals"},
      "7267.T": {"name": "ãƒ›ãƒ³ãƒ€", "country": "JP", "category": "automotive"},
      "6367.T": {"name": "ãƒ€ã‚¤ã‚­ãƒ³å·¥æ¥­", "country": "JP", "category": "industrial"},
      "4519.T": {"name": "ä¸­å¤–è£½è–¬", "country": "JP", "category": "pharma"},
      "9735.T": {"name": "ã‚»ã‚³ãƒ ", "country": "JP", "category": "security"},
      "4578.T": {"name": "å¤§å¡šãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹", "country": "JP", "category": "pharma"},
      "6326.T": {"name": "ã‚¯ãƒœã‚¿", "country": "JP", "category": "industrial"},
      "7751.T": {"name": "ã‚­ãƒ¤ãƒãƒ³", "country": "JP", "category": "electronics"}
  }

  def fetch_stock_data(symbol):
      """Alpha Vantage APIã‹ã‚‰å€‹åˆ¥éŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
      try:
          params = {
              'function': 'GLOBAL_QUOTE',
              'symbol': symbol,
              'apikey': API_KEY
          }

          response = requests.get(BASE_URL, params=params, timeout=10)
          data = response.json()

          if 'Global Quote' in data:
              quote = data['Global Quote']
              return {
                  'price': float(quote.get('05. price', 0)),
                  'change': float(quote.get('09. change', 0)),
                  'change_percent': float(quote.get('10. change percent', '0%').replace('%', '')),
                  'volume': int(quote.get('06. volume', 0)),
                  'last_update': datetime.now(timezone.utc).isoformat()
              }
          else:
              print(f"API Error for {symbol}: {data}")
              return None

      except Exception as e:
          print(f"Error fetching {symbol}: {e}")
          return None

  def generate_mock_data():
      """APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ"""
      import random

      stocks = []
      for symbol, info in STOCKS_TO_MONITOR.items():
          base_price = 2000  # æ—¥æœ¬æ ªã®ãƒ™ãƒ¼ã‚¹ä¾¡æ ¼
          price_variation = random.uniform(0.8, 1.2)
          price = round(base_price * price_variation, 2)

          change_percent = random.uniform(-3, 3)
          change = round(price * (change_percent / 100), 2)

          stocks.append({
              'symbol': symbol,
              'name': info['name'],
              'country': info['country'],
              'category': info['category'],
              'price': price,
              'change': change,
              'changePercent': change_percent,
              'volume': random.randint(100000, 2000000),
              'lastUpdate': datetime.now(timezone.utc).isoformat()
          })

      return stocks

  def main():
      """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
      print("ğŸ“Š Stock data generation started...")

      if not API_KEY or API_KEY == 'YOUR_ALPHA_VANTAGE_API_KEY_HERE':
          print("âš ï¸ No Alpha Vantage API key found, generating mock data...")
          stocks = generate_mock_data()
      else:
          print("ğŸ”— Fetching real data from Alpha Vantage API...")
          stocks = []

          for symbol, info in STOCKS_TO_MONITOR.items():
              print(f"  Fetching {symbol}...")

              stock_data = fetch_stock_data(symbol)

              if stock_data:
                  stocks.append({
                      'symbol': symbol,
                      'name': info['name'],
                      'country': info['country'],
                      'category': info['category'],
                      'price': stock_data['price'],
                      'change': stock_data['change'],
                      'changePercent': stock_data['change_percent'],
                      'volume': stock_data.get('volume', 0),
                      'lastUpdate': stock_data['last_update']
                  })

                  # APIåˆ¶é™å¯¾ç­–: 25éŠ˜æŸ„å¯¾å¿œ (5 API calls/minute = 12ç§’é–“éš”)
                  time.sleep(12.1)
              else:
                  print(f"  Failed to fetch {symbol}, skipping...")

      # ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
      output_dir = 'stock-monitor-pro/data'
      os.makedirs(output_dir, exist_ok=True)

      output_data = {
          'success': True,
          'timestamp': datetime.now(timezone.utc).isoformat(),
          'total': len(stocks),
          'data': stocks
      }

      output_file = os.path.join(output_dir, 'stocks.json')
      with open(output_file, 'w', encoding='utf-8') as f:
          json.dump(output_data, f, ensure_ascii=False, indent=2)

      print(f"âœ… Generated data for {len(stocks)} stocks")
      print(f"ğŸ“ Saved to: {output_file}")

  if __name__ == '__main__':
      main()

  2. .github/workflows/update-stock-data.yml (20å›/æ—¥ç‰ˆ):

  name: Update Stock Data

  on:
    schedule:
      # ğŸ”¥ APIåˆ¶é™500calls/æ—¥ã‚’å®Œå…¨æ´»ç”¨: 25éŠ˜æŸ„Ã—20å›=500calls (ç´„25åˆ†é–“éš”)
      - cron: '0,25,50 0 * * 1-5'          # 09:00, 09:25, 09:50 JST (3å›)
      - cron: '15,40 1 * * 1-5'            # 10:15, 10:40 JST (2å›)
      - cron: '5,30 2 * * 1-5'             # 11:05, 11:30 JST (2å›)
      - cron: '0,25,50 4 * * 1-5'          # 13:00, 13:25, 13:50 JST (3å›)
      - cron: '15,40 5 * * 1-5'            # 14:15, 14:40 JST (2å›)
      - cron: '5,30,55 6 * * 1-5'          # 15:05, 15:30, 15:55 JST (3å›)
      - cron: '20,45 7 * * 1-5'            # 16:20, 16:45 JST (2å›)
      - cron: '10,35 8 * * 1-5'            # 17:10, 17:35 JST (2å›)
      - cron: '0 9 * * 1-5'                # 18:00 JST (1å›)
      # åˆè¨ˆ: 3+2+2+3+2+3+2+2+1 = 20å›/æ—¥
    workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

  env:
    ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}

  jobs:
    update-stock-data:
      runs-on: ubuntu-latest

      permissions:
        contents: write

      steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Create data directory
        run: |
          mkdir -p stock-monitor-pro/data

      - name: Generate stock data
        run: |
          python generate_stock_data.py

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add stock-monitor-pro/data/stocks.json
          git diff --staged --quiet || git commit -m "ğŸ“Š Update 25 Japanese stocks - $(date '+%Y-%m-%d %H:%M')"
          git push
