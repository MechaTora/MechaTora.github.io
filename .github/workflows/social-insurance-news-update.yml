name: ç¤¾ä¼šä¿é™ºãƒ‹ãƒ¥ãƒ¼ã‚¹è‡ªå‹•æ›´æ–°

on:
  schedule:
    # æ¯Žæ—¥æœ4æ™‚(UTC 19:00 = JST 04:00)ã«å®Ÿè¡Œ
    - cron: '0 19 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°'
        required: false
        default: 'false'

jobs:
  update-social-insurance-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd render-social-insurance-news
        pip install -r requirements.txt
        
    - name: ãƒ‹ãƒ¥ãƒ¼ã‚¹è‡ªå‹•æ›´æ–°å®Ÿè¡Œ
      run: |
        cd render-social-insurance-news
        python scripts/main_automation.py
        
    - name: æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add render-social-insurance-news/data/
        
        if git diff --staged --quiet; then
          echo "å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        else
          git commit -m "ðŸ¤– ç¤¾ä¼šä¿é™ºãƒ‹ãƒ¥ãƒ¼ã‚¹è‡ªå‹•æ›´æ–° - $(TZ=Asia/Tokyo date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
          git push
        fi
        
    - name: Render Webhooké€šçŸ¥ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼ï¼‰
      if: success()
      run: |
        # Renderã®auto-deployãŒæœ‰åŠ¹ãªã®ã§ã€pushã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹
        echo "âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹æ›´æ–°å®Œäº† - Renderã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
        
    - name: å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼
      if: always()
      run: |
        echo "## ðŸ¤– ç¤¾ä¼šä¿é™ºãƒ‹ãƒ¥ãƒ¼ã‚¹æ›´æ–°ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(TZ=Asia/Tokyo date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "render-social-insurance-news/data/processed_news.json" ]; then
          NEWS_COUNT=$(python -c "import json; data=json.load(open('render-social-insurance-news/data/processed_news.json')); print(data['total_count'])")
          echo "- **åŽé›†ãƒ‹ãƒ¥ãƒ¼ã‚¹æ•°**: ${NEWS_COUNT}ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **ã‚µã‚¤ãƒˆURL**: https://social-insurance-news-render-1.onrender.com/" >> $GITHUB_STEP_SUMMARY