<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬19ç« : äºˆæ¸¬ã¨è§£é‡ˆ | Tidyverseå®Œå…¨ãƒã‚¹ã‚¿ãƒ¼</title>
    <link rel="canonical" href="https://mechatora.com/tidy-data-science/chapter19-prediction-interpretation.html">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RBPWE348T2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RBPWE348T2');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1184134440246706"
         crossorigin="anonymous"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --accent-neon: #00ff88;
            --accent-cyan: #00d4ff;
            --accent-purple: #9d4edd;
            --accent-emerald: #10d9c4;
            --accent-lime: #84cc16;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-neon: #00ff88;
            --shadow-neon: 0 0 20px #00ff8840;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.8;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
            background: linear-gradient(45deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 20px;
            border: 2px solid var(--border-neon);
            box-shadow: var(--shadow-neon);
        }

        h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, var(--accent-neon), var(--accent-cyan));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .nav-btn {
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-neon);
            border-radius: 10px;
            color: var(--accent-neon);
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: var(--accent-neon);
            color: var(--bg-primary);
            box-shadow: var(--shadow-neon);
        }

        /* Content Sections */
        .section {
            background: var(--bg-secondary);
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 15px;
            border: 1px solid var(--accent-purple);
            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
        }

        h2 {
            color: var(--accent-cyan);
            font-size: 2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h3 {
            color: var(--accent-emerald);
            font-size: 1.5rem;
            margin: 25px 0 15px 0;
        }

        h4 {
            color: var(--accent-lime);
            font-size: 1.2rem;
            margin: 20px 0 10px 0;
        }

        /* Code Blocks */
        pre {
            background: var(--bg-primary);
            border: 1px solid var(--accent-neon);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            position: relative;
        }

        pre::before {
            content: 'ğŸ’» R Code';
            position: absolute;
            top: -12px;
            right: 20px;
            background: var(--bg-secondary);
            color: var(--accent-neon);
            padding: 4px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        code {
            color: var(--accent-neon);
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* List Styles */
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        /* Special Boxes */
        .tip-box {
            background: linear-gradient(135deg, var(--accent-emerald)20, var(--bg-tertiary));
            border: 1px solid var(--accent-emerald);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .tip-box::before {
            content: 'ğŸ’¡ Tip';
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--bg-secondary);
            color: var(--accent-emerald);
            padding: 4px 12px;
            border-radius: 5px;
            font-weight: bold;
        }

        .warning-box {
            background: linear-gradient(135deg, #ff444420, var(--bg-tertiary));
            border: 1px solid #ff4444;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .warning-box::before {
            content: 'âš ï¸ æ³¨æ„';
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--bg-secondary);
            color: #ff4444;
            padding: 4px 12px;
            border-radius: 5px;
            font-weight: bold;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            nav {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-btn {
                width: 200px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”® ç¬¬19ç« : äºˆæ¸¬ã¨è§£é‡ˆ</h1>
            <p class="subtitle">å®Ÿç”¨çš„ãªäºˆæ¸¬ã¨ãƒ¢ãƒ‡ãƒ«è§£é‡ˆå¯èƒ½æ€§ã‚’ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹</p>
        </header>

        <nav>
            <a href="index.html" class="nav-button">ç›®æ¬¡ã¸æˆ»ã‚‹</a>
            <a href="chapter18-model-evaluation-yardstick.html" class="nav-btn">â¬…ï¸ å‰ã®ç« </a>
            <a href="chapter20-ensemble-learning-enhanced.html" class="nav-btn">â¡ï¸ æ¬¡ã®ç« </a>
        </nav>

        <div class="section">
            <h2>ğŸ¯ Chapter 19ã®å­¦ç¿’ç›®æ¨™</h2>
            <ul>
                <li><strong>æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ã®äºˆæ¸¬</strong>å®Ÿè¡Œã¨äºˆæ¸¬åŒºé–“ã®è¨ˆç®—</li>
                <li><strong>ãƒ¢ãƒ‡ãƒ«ã®è§£é‡ˆå¯èƒ½æ€§</strong>å‘ä¸Šæ‰‹æ³•</li>
                <li><strong>ç‰¹å¾´é‡é‡è¦åº¦</strong>ã®ç®—å‡ºã¨å¯è¦–åŒ–</li>
                <li><strong>SHAPå€¤ãƒ»LIME</strong>ã«ã‚ˆã‚‹å±€æ‰€çš„è§£é‡ˆ</li>
                <li><strong>éƒ¨åˆ†ä¾å­˜ãƒ—ãƒ­ãƒƒãƒˆ</strong>ã«ã‚ˆã‚‹å¤§åŸŸçš„è§£é‡ˆ</li>
            </ul>

            <pre>
# åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
library(tidymodels)
library(tidyverse)
library(vip)        # Variable Importance Plots
library(DALEXtra)   # Model Agnostic Explanations
library(DALEX)      # Descriptive mAchine Learning EXplanations

# ãƒ‡ãƒ¼ã‚¿ã¨ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™
data("ames", package = "modeldata")
ames_clean <- ames |>
  select(Sale_Price, Lot_Area, Year_Built, 
         Neighborhood, House_Style, Overall_Qual) |>
  mutate(log_price = log10(Sale_Price))

# Train/Teståˆ†å‰²
set.seed(123)
ames_split <- initial_split(ames_clean, prop = 0.8)
ames_train <- training(ames_split)
ames_test <- testing(ames_split)
</pre>
        </div>

        <div class="section">
            <h2>ğŸ” æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ã®äºˆæ¸¬</h2>
            
            <h3>1. åŸºæœ¬çš„ãªäºˆæ¸¬å®Ÿè¡Œ</h3>
            <p>è¨“ç·´æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§äºˆæ¸¬ã‚’è¡Œã„ã¾ã™ã€‚</p>

            <pre>
# Random Forest ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´
rf_recipe <- recipe(log_price ~ ., data = ames_train) |>
  step_rm(Sale_Price) |>
  step_dummy(all_nominal_predictors()) |>
  step_normalize(all_numeric_predictors()) |>
  step_zv(all_predictors())

rf_spec <- rand_forest(
  mtry = 4,
  trees = 500,
  min_n = 5
) |>
  set_engine("ranger", importance = "impurity") |>
  set_mode("regression")

rf_workflow <- workflow() |>
  add_recipe(rf_recipe) |>
  add_model(rf_spec)

# ãƒ¢ãƒ‡ãƒ«è¨“ç·´
rf_fit <- rf_workflow |> fit(ames_train)

# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ã®äºˆæ¸¬
test_predictions <- rf_fit |>
  predict(ames_test) |>
  bind_cols(ames_test |> select(log_price, Sale_Price))

test_predictions |>
  head(10)
</pre>

            <h3>2. äºˆæ¸¬åŒºé–“ã®è¨ˆç®—</h3>
            <p>äºˆæ¸¬ã®ä¸ç¢ºå®Ÿæ€§ã‚’é‡åŒ–ã—ã¦åŒºé–“æ¨å®šã‚’è¡Œã„ã¾ã™ã€‚</p>

            <pre>
# é‡åˆ†ä½å›å¸°ã«ã‚ˆã‚‹äºˆæ¸¬åŒºé–“
library(quantreg)

# åˆ†ä½ç‚¹äºˆæ¸¬ã®ãŸã‚ã®ãƒ¢ãƒ‡ãƒ«ï¼ˆè¤‡æ•°ã®åˆ†ä½ç‚¹ï¼‰
quantile_spec <- linear_reg() |>
  set_engine("quantreg", tau = 0.1)  # 10%åˆ†ä½ç‚¹

# ç•°ãªã‚‹åˆ†ä½ç‚¹ã§ã®äºˆæ¸¬
quantiles <- c(0.1, 0.25, 0.5, 0.75, 0.9)

quantile_predictions <- map_dfr(quantiles, ~ {
  quantile_model <- linear_reg() |>
    set_engine("quantreg", tau = .x) |>
    set_mode("regression")
  
  quantile_wf <- workflow() |>
    add_recipe(rf_recipe) |>
    add_model(quantile_model)
  
  quantile_fit <- quantile_wf |> fit(ames_train)
  
  predict(quantile_fit, ames_test) |>
    mutate(quantile = .x)
}) |>
  bind_cols(ames_test |> select(log_price) |> slice(rep(1:n(), 5)))

# äºˆæ¸¬åŒºé–“ã®å¯è¦–åŒ–
prediction_intervals <- quantile_predictions |>
  pivot_wider(names_from = quantile, values_from = .pred, names_prefix = "q") |>
  mutate(row_id = row_number())

prediction_intervals |>
  slice_head(n = 50) |>
  ggplot(aes(x = row_id)) +
  geom_ribbon(aes(ymin = q0.1, ymax = q0.9), alpha = 0.3, fill = "lightblue") +
  geom_ribbon(aes(ymin = q0.25, ymax = q0.75), alpha = 0.5, fill = "lightgreen") +
  geom_line(aes(y = q0.5), color = "blue", size = 1) +
  geom_point(aes(y = log_price), color = "red", alpha = 0.7) +
  labs(title = "Prediction Intervals",
       x = "Observation", y = "Log Price",
       subtitle = "Blue ribbon: 80% interval, Green: 50% interval") +
  theme_minimal()
</pre>

            <h3>3. Bootstrap ã«ã‚ˆã‚‹äºˆæ¸¬åŒºé–“</h3>
            <pre>
# Bootstrap ã«ã‚ˆã‚‹äºˆæ¸¬åŒºé–“
library(rsample)

# Bootstrap ã‚µãƒ³ãƒ—ãƒ«ã§ã®ãƒ¢ãƒ‡ãƒ«è¨“ç·´
bootstrap_models <- bootstraps(ames_train, times = 100) |>
  mutate(
    models = map(splits, ~ {
      boot_data <- analysis(.x)
      rf_workflow |> fit(boot_data)
    })
  )

# æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ç‚¹ã§ã®äºˆæ¸¬ï¼ˆä¾‹ï¼šæœ€åˆã®ãƒ†ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
new_observation <- ames_test |> slice(1)

bootstrap_predictions <- bootstrap_models |>
  mutate(
    predictions = map_dbl(models, ~ {
      predict(.x, new_observation)$.pred
    })
  )

# äºˆæ¸¬åŒºé–“ã®è¨ˆç®—
prediction_summary <- bootstrap_predictions |>
  summarise(
    median_pred = median(predictions),
    lower_95 = quantile(predictions, 0.025),
    upper_95 = quantile(predictions, 0.975),
    lower_50 = quantile(predictions, 0.25),
    upper_50 = quantile(predictions, 0.75)
  )

prediction_summary
</pre>
        </div>

        <div class="section">
            <h2>ğŸ“Š ç‰¹å¾´é‡é‡è¦åº¦åˆ†æ</h2>
            
            <h3>1. ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®é‡è¦åº¦</h3>
            <p>Random Forestã®å†…è”µé‡è¦åº¦æŒ‡æ¨™ã‚’æ´»ç”¨ã—ã¾ã™ã€‚</p>

            <pre>
# vipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚ˆã‚‹é‡è¦åº¦å¯è¦–åŒ–
library(vip)

# åŸºæœ¬çš„ãªç‰¹å¾´é‡é‡è¦åº¦
importance_plot <- rf_fit |>
  extract_fit_parsnip() |>
  vip(num_features = 15, geom = "col") +
  theme_minimal() +
  labs(title = "Feature Importance (Random Forest)")

importance_plot

# æ•°å€¤ã§ã®é‡è¦åº¦å–å¾—
importance_values <- rf_fit |>
  extract_fit_parsnip() |>
  vi() |>
  arrange(desc(Importance))

importance_values
</pre>

            <h3>2. Permutation Importance</h3>
            <p>ãƒ¢ãƒ‡ãƒ«ã«ä¾å­˜ã—ãªã„é‡è¦åº¦æ¸¬å®šæ‰‹æ³•ã§ã™ã€‚</p>

            <pre>
# Permutation importanceã®è¨ˆç®—
library(DALEX)

# DALEX explainerã®ä½œæˆ
explainer <- explain(
  model = rf_fit,
  data = ames_train |> select(-log_price, -Sale_Price),
  y = ames_train$log_price,
  label = "Random Forest",
  verbose = FALSE
)

# Permutation importanceã®è¨ˆç®—
perm_importance <- model_parts(explainer, type = "difference")

# çµæœã®å¯è¦–åŒ–
plot(perm_importance) + 
  ggtitle("Permutation Feature Importance") +
  theme_minimal()

# æ•°å€¤çµæœ
perm_importance$result |>
  filter(permutation == 0) |>  # baseline
  arrange(desc(dropout_loss)) |>
  head(10)
</pre>

            <h3>3. SHAPå€¤ã«ã‚ˆã‚‹é‡è¦åº¦</h3>
            <pre>
# SHAPå€¤ã®è¨ˆç®—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ï¼‰
library(shapr)

# å°‘æ•°ã‚µãƒ³ãƒ—ãƒ«ã§ã®SHAPå€¤è¨ˆç®—
sample_data <- ames_test |> 
  select(-log_price, -Sale_Price) |>
  slice_head(n = 10)

# SHAPå€¤è¨ˆç®—ã®æº–å‚™
shap_explainer <- explain(
  model = rf_fit,
  data = ames_train |> select(-log_price, -Sale_Price),
  y = ames_train$log_price,
  verbose = FALSE
)

# SHAPå€¤è¨ˆç®—
shap_values <- predict_parts(
  shap_explainer, 
  new_observation = sample_data[1, ],
  type = "shap"
)

# SHAPå€¤ã®å¯è¦–åŒ–
plot(shap_values) + 
  ggtitle("SHAP Values for Single Prediction") +
  theme_minimal()
</pre>
        </div>

        <div class="section">
            <h2>ğŸŒ å¤§åŸŸçš„è§£é‡ˆï¼šéƒ¨åˆ†ä¾å­˜ãƒ—ãƒ­ãƒƒãƒˆ</h2>
            
            <h3>1. å˜å¤‰æ•°éƒ¨åˆ†ä¾å­˜ãƒ—ãƒ­ãƒƒãƒˆ</h3>
            <p>å€‹ã€…ã®ç‰¹å¾´é‡ãŒãƒ¢ãƒ‡ãƒ«äºˆæ¸¬ã«ä¸ãˆã‚‹å¹³å‡çš„ãªå½±éŸ¿ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>

            <pre>
# éƒ¨åˆ†ä¾å­˜ãƒ—ãƒ­ãƒƒãƒˆã®ä½œæˆ
pdp_year_built <- model_profile(
  explainer,
  variables = "Year_Built",
  N = 100  # ã‚µãƒ³ãƒ—ãƒ«æ•°
)

# å¯è¦–åŒ–
plot(pdp_year_built) +
  ggtitle("Partial Dependence: Year_Built") +
  theme_minimal()

# è¤‡æ•°å¤‰æ•°ã®éƒ¨åˆ†ä¾å­˜ãƒ—ãƒ­ãƒƒãƒˆ
pdp_multi <- model_profile(
  explainer,
  variables = c("Year_Built", "Lot_Area", "Overall_Qual"),
  N = 50
)

plot(pdp_multi) +
  ggtitle("Partial Dependence: Multiple Variables") +
  theme_minimal()
</pre>

            <h3>2. 2æ¬¡å…ƒéƒ¨åˆ†ä¾å­˜ãƒ—ãƒ­ãƒƒãƒˆ</h3>
            <pre>
# 2å¤‰æ•°é–“ã®ç›¸äº’ä½œç”¨
pdp_2d <- model_profile(
  explainer,
  variables = c("Year_Built", "Overall_Qual"),
  type = "partial",
  variable_splits = list(
    Year_Built = seq(1900, 2010, by = 20),
    Overall_Qual = 1:10
  )
)

# ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã§ã®å¯è¦–åŒ–
library(plotly)

# ãƒ‡ãƒ¼ã‚¿æ•´å½¢
pdp_data <- pdp_2d$result |>
  select(`_vname_`, `_x_`, `_yhat_`) |>
  pivot_wider(names_from = `_vname_`, values_from = `_x_`) |>
  filter(!is.na(Year_Built), !is.na(Overall_Qual))

# ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ä½œæˆ
ggplot(pdp_data, aes(x = Year_Built, y = Overall_Qual, fill = `_yhat_`)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted\nLog Price") +
  labs(title = "2D Partial Dependence Plot",
       x = "Year Built", y = "Overall Quality") +
  theme_minimal()
</pre>

            <h3>3. ç´¯ç©å±€æ‰€åŠ¹æœãƒ—ãƒ­ãƒƒãƒˆï¼ˆALEï¼‰</h3>
            <pre>
# ALE plotã®ä½œæˆ
ale_plot <- model_profile(
  explainer,
  variables = "Year_Built",
  type = "accumulated"
)

plot(ale_plot) +
  ggtitle("Accumulated Local Effects: Year_Built") +
  theme_minimal()

# è¤‡æ•°å¤‰æ•°ã®ALE
ale_multi <- model_profile(
  explainer,
  variables = c("Year_Built", "Lot_Area"),
  type = "accumulated"
)

plot(ale_multi) +
  ggtitle("ALE Plots: Multiple Variables") +
  theme_minimal()
</pre>
        </div>

        <div class="section">
            <h2>ğŸ¯ å±€æ‰€çš„è§£é‡ˆï¼šLIME</h2>
            
            <h3>1. LIME ã«ã‚ˆã‚‹å€‹åˆ¥äºˆæ¸¬ã®èª¬æ˜</h3>
            <p>Local Interpretable Model-agnostic Explanations ã«ã‚ˆã‚‹å±€æ‰€çš„è§£é‡ˆã§ã™ã€‚</p>

            <pre>
# LIMEã«ã‚ˆã‚‹å±€æ‰€çš„èª¬æ˜
library(lime)

# LIME explainerã®ä½œæˆ
lime_explainer <- lime(
  x = ames_train |> select(-log_price, -Sale_Price),
  model = rf_fit,
  bin_continuous = TRUE,
  n_bins = 4
)

# å€‹åˆ¥ã‚µãƒ³ãƒ—ãƒ«ã®èª¬æ˜
explanation <- explain(
  x = ames_test |> slice(1:3) |> select(-log_price, -Sale_Price),
  explainer = lime_explainer,
  n_features = 10,
  n_permutations = 1000
)

# çµæœã®å¯è¦–åŒ–
plot_features(explanation) +
  labs(title = "LIME Explanations for Individual Predictions") +
  theme_minimal()

# èª¬æ˜ã®è©³ç´°
explanation |>
  select(case, feature, feature_weight, feature_desc) |>
  arrange(case, desc(abs(feature_weight)))
</pre>

            <h3>2. ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã®è§£é‡ˆ</h3>
            <pre>
# ã‚ˆã‚Šè©³ç´°ãª LIME èª¬æ˜
detailed_explanation <- explain(
  x = ames_test |> slice(1) |> select(-log_price, -Sale_Price),
  explainer = lime_explainer,
  n_features = 5,
  feature_select = "highest_weights"
)

# ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®èª¬æ˜ç”Ÿæˆ
explanation_text <- detailed_explanation |>
  mutate(
    contribution = ifelse(feature_weight > 0, 
                         paste("å¢—åŠ è¦å› :", feature_desc), 
                         paste("æ¸›å°‘è¦å› :", feature_desc)),
    impact = paste0("(å½±éŸ¿åº¦: ", round(abs(feature_weight), 3), ")")
  ) |>
  select(contribution, impact) |>
  unite("explanation", contribution:impact, sep = " ")

cat("äºˆæ¸¬å€¤:", round(detailed_explanation$prediction[1], 3), "\n")
cat("å®Ÿéš›å€¤:", round(ames_test$log_price[1], 3), "\n\n")
cat("ä¸»è¦ãªèª¬æ˜è¦å› :\n")
cat(paste(explanation_text$explanation, collapse = "\n"))
</pre>
        </div>

        <div class="section">
            <h2>ğŸ”§ è§£é‡ˆå¯èƒ½æ€§ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h2>
            
            <h3>1. åŒ…æ‹¬çš„è§£é‡ˆãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <pre>
# åŒ…æ‹¬çš„è§£é‡ˆé–¢æ•°
comprehensive_interpretation <- function(model, train_data, test_data, target_col) {
  
  # åŸºæœ¬æƒ…å ±
  model_info <- list(
    model_type = class(model)[1],
    n_features = ncol(train_data) - 1,
    n_train = nrow(train_data),
    n_test = nrow(test_data)
  )
  
  # å…¨ä½“çš„é‡è¦åº¦
  global_importance <- model |>
    extract_fit_parsnip() |>
    vi() |>
    arrange(desc(Importance))
  
  # äºˆæ¸¬æ€§èƒ½
  predictions <- predict(model, test_data) |>
    bind_cols(test_data |> select(all_of(target_col)))
  
  performance <- predictions |>
    metrics(truth = all_of(target_col), estimate = .pred)
  
  # ç‰¹å¾´é‡çµ±è¨ˆ
  feature_stats <- train_data |>
    select(-all_of(target_col)) |>
    summarise(across(everything(), list(
      mean = ~ mean(.x, na.rm = TRUE),
      median = ~ median(.x, na.rm = TRUE),
      sd = ~ sd(.x, na.rm = TRUE)
    )))
  
  list(
    model_info = model_info,
    performance = performance,
    importance = global_importance,
    feature_stats = feature_stats,
    predictions = predictions
  )
}

# å®Ÿè¡Œ
interpretation_report <- comprehensive_interpretation(
  rf_fit, 
  ames_train, 
  ames_test, 
  "log_price"
)

# ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
interpretation_report$model_info
interpretation_report$performance
interpretation_report$importance |> head(10)
</pre>

            <h3>2. å¯¾è©±çš„è§£é‡ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
            <pre>
# Shiny ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚³ãƒ¼ãƒ‰ä¾‹
library(shiny)
library(plotly)

# UIå®šç¾©ï¼ˆç°¡ç•¥ç‰ˆï¼‰
ui <- fluidPage(
  titlePanel("Model Interpretation Dashboard"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("interpretation_type", "è§£é‡ˆæ‰‹æ³•:",
                  choices = c("Feature Importance", "Partial Dependence", 
                             "SHAP Values", "LIME")),
      selectInput("feature", "ç‰¹å¾´é‡é¸æŠ:",
                  choices = names(ames_train)),
      numericInput("sample_id", "ã‚µãƒ³ãƒ—ãƒ«ID:", value = 1, min = 1, max = 100)
    ),
    
    mainPanel(
      plotlyOutput("interpretation_plot"),
      verbatimTextOutput("interpretation_text")
    )
  )
)

# Serverå®šç¾©ï¼ˆç°¡ç•¥ç‰ˆï¼‰
server <- function(input, output, session) {
  
  output$interpretation_plot <- renderPlotly({
    # é¸æŠã•ã‚ŒãŸè§£é‡ˆæ‰‹æ³•ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒƒãƒˆç”Ÿæˆ
    if(input$interpretation_type == "Feature Importance") {
      p <- rf_fit |>
        extract_fit_parsnip() |>
        vip(num_features = 10) +
        theme_minimal()
      ggplotly(p)
    }
    # ä»–ã®è§£é‡ˆæ‰‹æ³•ã‚‚åŒæ§˜ã«å®Ÿè£…
  })
  
  output$interpretation_text <- renderText({
    paste("é¸æŠã•ã‚ŒãŸè§£é‡ˆæ‰‹æ³•:", input$interpretation_type)
  })
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
# shinyApp(ui = ui, server = server)
</pre>

            <div class="tip-box">
                <p><strong>è§£é‡ˆå¯èƒ½æ€§ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼š</strong></p>
                <ul>
                    <li><strong>è¤‡æ•°æ‰‹æ³•ã®çµ„ã¿åˆã‚ã›</strong>: å¤§åŸŸçš„ãƒ»å±€æ‰€çš„è§£é‡ˆã®ä½µç”¨</li>
                    <li><strong>ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼è€ƒæ…®</strong>: å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¿œã˜ãŸèª¬æ˜</li>
                    <li><strong>ç¶™ç¶šçš„æ¤œè¨¼</strong>: æ™‚é–“çµŒéã«ã‚ˆã‚‹è§£é‡ˆã®å¤‰åŒ–ç¢ºèª</li>
                    <li><strong>ãƒã‚¤ã‚¢ã‚¹æ¤œå‡º</strong>: ä¸å…¬å¹³ãªåˆ¤æ–­åŸºæº–ã®ç‰¹å®š</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ¯ ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2>
            
            <h3>Chapter 19ã§å­¦ã‚“ã ã“ã¨</h3>
            <ul>
                <li>æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ã®äºˆæ¸¬å®Ÿè¡Œã¨äºˆæ¸¬åŒºé–“ã®è¨ˆç®—</li>
                <li>ç‰¹å¾´é‡é‡è¦åº¦ã®å¤šè§’çš„ãªåˆ†ææ‰‹æ³•</li>
                <li>éƒ¨åˆ†ä¾å­˜ãƒ—ãƒ­ãƒƒãƒˆã«ã‚ˆã‚‹å¤§åŸŸçš„è§£é‡ˆ</li>
                <li>LIMEãƒ»SHAPã«ã‚ˆã‚‹å±€æ‰€çš„è§£é‡ˆ</li>
                <li>åŒ…æ‹¬çš„ãªè§£é‡ˆãƒ¬ãƒãƒ¼ãƒˆã®ä½œæˆ</li>
            </ul>

            <h3>å®Ÿç”¨åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
            <div class="warning-box">
                <ul>
                    <li><strong>è§£é‡ˆã®é™ç•Œã‚’ç†è§£</strong>: ç›¸é–¢ã¨å› æœã®åŒºåˆ¥</li>
                    <li><strong>è¨ˆç®—ã‚³ã‚¹ãƒˆã®è€ƒæ…®</strong>: å®Ÿæ™‚é–“åˆ¶ç´„ã¨ã® ãƒãƒ©ãƒ³ã‚¹</li>
                    <li><strong>èª¬æ˜ã®å“è³ªæ‹…ä¿</strong>: è§£é‡ˆçµæœã®å¦¥å½“æ€§æ¤œè¨¼</li>
                    <li><strong>ç¶™ç¶šçš„ç›£è¦–</strong>: ãƒ¢ãƒ‡ãƒ«ãƒ‰ãƒªãƒ•ãƒˆã®æ¤œå‡º</li>
                </ul>
            </div>

            <h3>æ¬¡ã®ç« ã¸ã®æº–å‚™</h3>
            <p>æ¬¡ã®ç¬¬20ç« ã§ã¯ã€è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã‚‹<strong>ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«å­¦ç¿’</strong>ã‚’å­¦ç¿’ã—ã¾ã™ã€‚stacksãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€äºˆæ¸¬ç²¾åº¦ã‚’ã•ã‚‰ã«å‘ä¸Šã•ã›ã‚‹æ‰‹æ³•ã‚’ç¿’å¾—ã—ã¾ã—ã‚‡ã†ã€‚</p>
        </div>

        <nav style="margin-top: 40px;">
            <a href="index.html" class="nav-button">ç›®æ¬¡ã¸æˆ»ã‚‹</a>
            <a href="chapter18-model-evaluation-yardstick.html" class="nav-btn">â¬…ï¸ å‰ã®ç« </a>
            <a href="chapter20-ensemble-learning-enhanced.html" class="nav-btn">â¡ï¸ æ¬¡ã®ç« </a>
        </nav>

        <div class="navigation">
            <a href="chapter23-deep-learning-torch.html" class="nav-button">â† å‰ã®ç« </a>
            <a href="index.html" class="nav-button">ç›®æ¬¡ã¸æˆ»ã‚‹</a>
            <a href="chapter1-tidyverse-overview.html" class="nav-button">æ¬¡ã®ç«  â†’</a>
        </div>

    <!-- å­¦ç¿’ã«ãŠã™ã™ã‚ã®æ›¸ç± -->
    <section class="book-recommendations" style="margin: 4rem 0; padding: 2rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; backdrop-filter: blur(10px);">
        <div class="container">
            <h3 style="color: var(--neon-cyan); font-family: var(--font-tech); font-size: 1.8rem; margin-bottom: 2rem; text-align: center;">
                ğŸ“š å­¦ç¿’ã«ãŠã™ã™ã‚ã®æ›¸ç±
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">
                
                <!-- Book 1 -->
                <div class="book-card" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 15px; padding: 1.5rem; transition: all 0.3s ease; position: relative; overflow: hidden;">
                    <a href="https://amzn.to/48d9vpc" target="_blank" rel="noopener" style="text-decoration: none; color: inherit;">
                        <div style="display: flex; flex-direction: column; height: 100%;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--neon-lime); font-size: 1.2rem; margin-bottom: 1rem; font-family: var(--font-tech);">
                                    ğŸ”¥ Rãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã®RStudio[å®Ÿè·µ]å…¥é–€
                                </h4>
                                <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.95rem; line-height: 1.6; margin-bottom: 1rem;">
                                    tidyverseã®åŸºç¤ã‹ã‚‰å®Ÿè·µã¾ã§ç¶²ç¾…ã—ãŸæ—¥æœ¬èªæ±ºå®šç‰ˆã€‚RStudioã¨tidyverseã§ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’ãƒã‚¹ã‚¿ãƒ¼ã€‚
                                </p>
                            </div>
                            <div style="background: var(--gradient-cyber); color: var(--void-black); padding: 0.8rem 1.5rem; border-radius: 25px; text-align: center; font-weight: 600; font-family: var(--font-tech); margin-top: auto;">
                                Amazonã§è©³ç´°ã‚’è¦‹ã‚‹ â†’
                            </div>
                        </div>
                    </a>
                </div>
                
                <!-- Book 2 -->
                <div class="book-card" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 15px; padding: 1.5rem; transition: all 0.3s ease; position: relative; overflow: hidden;">
                    <a href="https://amzn.to/3IfcanU" target="_blank" rel="noopener" style="text-decoration: none; color: inherit;">
                        <div style="display: flex; flex-direction: column; height: 100%;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--neon-magenta); font-size: 1.2rem; margin-bottom: 1rem; font-family: var(--font-tech);">
                                    ğŸ¤– Rãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã®tidymodels[å®Ÿè·µ]å…¥é–€
                                </h4>
                                <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.95rem; line-height: 1.6; margin-bottom: 1rem;">
                                    tidymodelsã§æ©Ÿæ¢°å­¦ç¿’ã‚’å®Ÿè·µã™ã‚‹ãŸã‚ã®æ—¥æœ¬èªã‚¬ã‚¤ãƒ‰ã€‚ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰ã‹ã‚‰è©•ä¾¡ã¾ã§å®Œå…¨ç¶²ç¾…ã€‚
                                </p>
                            </div>
                            <div style="background: var(--gradient-plasma); color: white; padding: 0.8rem 1.5rem; border-radius: 25px; text-align: center; font-weight: 600; font-family: var(--font-tech); margin-top: auto;">
                                Amazonã§è©³ç´°ã‚’è¦‹ã‚‹ â†’
                            </div>
                        </div>
                    </a>
                </div>
                
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; font-style: italic;">
                    â€» å½“ã‚µã‚¤ãƒˆã¯Amazonã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å‚åŠ ã—ã¦ã„ã¾ã™
                </p>
            </div>
        </div>
    </section>
    
    <style>
    .book-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        border-color: var(--neon-cyan);
    }

    .book-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
    }

    .book-card:hover::before {
        left: 100%;
    }
    </style>

    </div>
</body>
</html>