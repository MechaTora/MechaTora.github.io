name: render-social-insurance-news è‡ªå‹•æ›´æ–°

on:
  schedule:
    # æ¯æ—¥æœ4æ™‚ã«å®Ÿè¡Œï¼ˆUTCæ™‚é–“ã§19æ™‚ = JST 4æ™‚ï¼‰
    - cron: '0 19 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  metadata: read

jobs:
  update-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Pythonç’°å¢ƒè¨­å®š
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install --upgrade pip
        pip install -r render-social-insurance-news/requirements.txt
    
    - name: ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†ãƒ»å‡¦ç†å®Ÿè¡Œ
      run: |
        echo "ğŸš€ render-social-insurance-news è‡ªå‹•å‡¦ç†é–‹å§‹"
        cd render-social-insurance-news
        python scripts/main_automation.py
    
    - name: ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
      run: |
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
        ls -la render-social-insurance-news/data/*.json render-social-insurance-news/templates/*.html 2>/dev/null || echo "No files generated"
    
    - name: Gitè¨­å®šã¨ã‚³ãƒŸãƒƒãƒˆ
      run: |
        # Gitè¨­å®š
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git config --global --add safe.directory $PWD
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ å¤‰æ›´ã‚’æ¤œå‡ºã€ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ"
          git add render-social-insurance-news/data/*.json render-social-insurance-news/templates/*.html render-social-insurance-news/static/*
          
          # æ—¥æ™‚æƒ…å ±ã§ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
          CURRENT_TIME=$(TZ='Asia/Tokyo' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
          git commit -m "ğŸ”„ render-social-insurance-news è‡ªå‹•æ›´æ–° - ${CURRENT_TIME}" \
                     -m "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" \
                     -m "Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œï¼ˆå¼·åˆ¶çš„ã«èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ï¼‰
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main
          echo "âœ… æ›´æ–°å®Œäº†"
        else
          echo "â„¹ï¸ å¤‰æ›´ãªã—ã€ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
        fi
    
    - name: å®Ÿè¡Œçµæœé€šçŸ¥
      if: always()
      run: |
        if [ -f "render-social-insurance-news/data/build_info.json" ]; then
          echo "ğŸ“Š ãƒ“ãƒ«ãƒ‰æƒ…å ±:"
          cat render-social-insurance-news/data/build_info.json
        fi
        
        if [ -f "render-social-insurance-news/data/daily_report.json" ]; then
          echo "ğŸ“ˆ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ:"
          cat render-social-insurance-news/data/daily_report.json
        fi
        
        echo "ğŸ‰ render-social-insurance-news è‡ªå‹•æ›´æ–°å‡¦ç†å®Œäº†"

  # ã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify-error:
    needs: update-news
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: ã‚¨ãƒ©ãƒ¼é€šçŸ¥
      run: |
        echo "âŒ render-social-insurance-news è‡ªå‹•æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        echo "è©³ç´°ã¯Action logã‚’ç¢ºèªã—ã¦ãã ã•ã„"