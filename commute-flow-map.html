<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å›½éƒ½å¸‚åœé€šå‹¤æµå‹•ãƒãƒƒãƒ— | Japan Commuter Flow Map - äººã®æµã‚Œã‚’å¯è¦–åŒ– | Visualizing Human Flow</title>
    <meta name="description" content="é–¢æ±ãƒ»ä¸­éƒ¨ãƒ»é–¢è¥¿ãƒ»ç¦å²¡åœã®é€šå‹¤æµå‹•ã‚’å¯è¦–åŒ–ã—ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ—ã€‚Interactive map visualizing commuter flows in Kanto, Chubu, Kansai, and Fukuoka regions. ã©ã“ã‹ã‚‰ã©ã“ã¸äººãŒç§»å‹•ã—ã¦ã„ã‚‹ã‹ã‚’ç›´æ„Ÿçš„ã«æŠŠæ¡ã§ãã¾ã™ã€‚">
    <meta name="keywords" content="é€šå‹¤,æµå‹•,é¦–éƒ½åœ,å¯è¦–åŒ–,ãƒãƒƒãƒ—,äººå£ç§»å‹•,å›½å‹¢èª¿æŸ»,commute,flow,metropolitan,visualization,map,population,movement,Japan">
    
    <!-- Open Graph -->
    <meta property="og:title" content="å…¨å›½éƒ½å¸‚åœé€šå‹¤æµå‹•ãƒãƒƒãƒ— | Japan Commuter Flow Map">
    <meta property="og:description" content="é–¢æ±ãƒ»ä¸­éƒ¨ãƒ»é–¢è¥¿ãƒ»ç¦å²¡åœã®é€šå‹¤æµå‹•ã‚’å¯è¦–åŒ– | Interactive visualization of commuter flows in major Japanese metropolitan areas">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mechatora.com/commute-flow-map.html">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- GitHub Pages to mechatora.com redirect -->
    <script>
    if (window.location.hostname === 'mechatora.github.io') {
        window.location.replace('https://mechatora.com' + window.location.pathname + window.location.search + window.location.hash);
    }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #dc2626;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .map-container {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 600px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-panel {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            height: fit-content;
        }

        .control-section {
            margin-bottom: 2rem;
        }

        .control-section h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .btn:focus {
            outline: 3px solid #4f46e5;
            outline-offset: 2px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--gradient-secondary);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .info-panel {
            background: var(--background);
            border-radius: 12px;
            padding: 1.25rem;
            border: 2px solid var(--border);
        }

        .info-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .info-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend {
            margin-top: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 4px;
            margin-right: 0.75rem;
            border-radius: 2px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            z-index: 1000;
            max-width: 90vw;
            box-sizing: border-box;
        }
        
        @media (max-width: 640px) {
            .loading {
                padding: 1.5rem;
                border-radius: 10px;
                font-size: 0.9rem;
            }
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1.5rem;
            }
            
            .header h1 {
                font-size: 2.2rem;
                line-height: 1.3;
            }
            
            .header p {
                font-size: 1rem;
                padding: 0 2rem;
            }
            
            .map-container {
                height: 500px;
                order: 2;
            }
            
            .control-panel {
                order: 1;
                padding: 1.25rem;
            }
            
            .button-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }
            
            .btn {
                padding: 1rem;
                font-size: 0.85rem;
                text-align: center;
            }
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
        @media (max-width: 640px) {
            .header {
                padding: 1.5rem 1rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
                line-height: 1.4;
            }
            
            .header p {
                font-size: 0.95rem;
                padding: 0 1rem;
            }
            
            .main-container {
                padding: 0.75rem;
                gap: 1rem;
            }
            
            .map-container {
                height: 350px;
                border-radius: 15px;
            }
            
            .control-panel {
                padding: 1rem;
                border-radius: 15px;
            }
            
            .control-section {
                margin-bottom: 1.5rem;
            }
            
            .control-section h3 {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }
            
            .button-group {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .btn {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
                border-radius: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .stat-item {
                padding: 0.875rem;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .info-panel {
                padding: 1rem;
            }
            
            .info-title {
                font-size: 0.95rem;
                line-height: 1.4;
            }
            
            .info-content {
                font-size: 0.85rem;
                line-height: 1.5;
            }
            
            .legend {
                margin-top: 1rem;
            }
            
            .legend h3 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .legend-item {
                font-size: 0.8rem;
                margin-bottom: 0.4rem;
            }
            
            .congestion-ranking {
                max-height: 250px;
            }
            
            .congestion-item {
                padding: 0.6rem;
                margin-bottom: 0.4rem;
            }
            
            .congestion-rank {
                font-size: 1rem;
                width: 25px;
            }
            
            .congestion-line {
                font-size: 0.8rem;
            }
            
            .congestion-section {
                font-size: 0.75rem;
            }
            
            .congestion-stats {
                font-size: 0.7rem;
            }
        }
        
        /* å°ã•ãªã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.6rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .map-container {
                height: 300px;
            }
            
            .control-panel {
                padding: 0.875rem;
            }
            
            .btn {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .legend-item {
                font-size: 0.75rem;
            }
            
            .congestion-ranking {
                max-height: 200px;
            }
        }
        
        /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ã®æœ€é©åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æœ€å°ã‚µã‚¤ã‚º */
                padding: 1rem;
            }
            
            .congestion-item {
                min-height: 44px;
                padding: 0.75rem;
            }
            
            .stat-item {
                min-height: 60px;
                padding: 1rem;
            }
            
            /* ãƒ›ãƒãƒ¼åŠ¹æœã‚’ã‚¿ãƒƒãƒ—åŠ¹æœã«å¤‰æ›´ */
            .btn:active {
                transform: translateY(-1px);
                box-shadow: var(--shadow);
            }
            
            .congestion-item:active {
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
        }
        
        /* æ··é›‘ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º */
        .congestion-ranking {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .congestion-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--background);
            border-radius: 8px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .congestion-item:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .congestion-rank {
            font-size: 1.2rem;
            font-weight: 700;
            width: 30px;
            text-align: center;
            margin-right: 0.75rem;
        }
        
        .congestion-info {
            flex: 1;
        }
        
        .congestion-line {
            font-weight: 600;
            margin-bottom: 0.2rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .congestion-section {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }
        
        .congestion-stats {
            display: flex;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        
        .congestion-rate {
            background: #ef4444;
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .congestion-passengers {
            color: var(--text-secondary);
        }
        
        /* æ··é›‘åº¦ã«ã‚ˆã‚‹è‰²åˆ†ã‘ */
        .congestion-item.extreme { border-left-color: #dc2626; }
        .congestion-item.high { border-left-color: #ea580c; }
        .congestion-item.medium { border-left-color: #d97706; }
        .congestion-item.low { border-left-color: #16a34a; }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ—ºï¸ å…¨å›½éƒ½å¸‚åœé€šå‹¤æµå‹•ãƒãƒƒãƒ—<br><span style="font-size: 0.7em; font-weight: 400; opacity: 0.9;">Japan Commuter Flow Map</span></h1>
        <p>é–¢æ±ãƒ»ä¸­éƒ¨ãƒ»é–¢è¥¿ãƒ»ç¦å²¡åœã®äººã®æµã‚Œã‚’å¯è¦–åŒ–<br><span style="font-size: 0.9em; opacity: 0.8;">Visualizing commuter flows in Kanto, Chubu, Kansai & Fukuoka regions</span></p>
    </header>

    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...<br><span style="font-size: 0.9em; opacity: 0.8;">Loading data...</span></p>
            </div>
        </div>

        <div class="control-panel">
            <div class="control-section">
                <h3>ğŸ—¾ åœ°åŸŸé¸æŠ | Region Selection</h3>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="switchRegion('kanto')" id="btn-kanto" 
             aria-label="é–¢æ±åœã‚’è¡¨ç¤º - Display Kanto region" tabindex="0">
                        ğŸ—¼ é–¢æ±åœ<br><span style="font-size: 0.8em; opacity: 0.8;">Kanto</span>
                    </button>
                    <button class="btn" style="background: #059669; color: white;" onclick="switchRegion('chubu')" id="btn-chubu"
             aria-label="ä¸­éƒ¨åœã‚’è¡¨ç¤º - Display Chubu region" tabindex="0">
                        ğŸ¯ ä¸­éƒ¨åœ<br><span style="font-size: 0.8em; opacity: 0.8;">Chubu</span>
                    </button>
                    <button class="btn" style="background: #dc2626; color: white;" onclick="switchRegion('kansai')" id="btn-kansai">
                        ğŸ° é–¢è¥¿åœ<br><span style="font-size: 0.8em; opacity: 0.8;">Kansai</span>
                    </button>
                    <button class="btn" style="background: #7c3aed; color: white;" onclick="switchRegion('fukuoka')" id="btn-fukuoka">
                        ğŸ® ç¦å²¡åœ<br><span style="font-size: 0.8em; opacity: 0.8;">Fukuoka</span>
                    </button>
                </div>
            </div>
            
            <div class="control-section">
                <h3>âš¡ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ | Animation</h3>
                <div class="button-group">
                    <button class="btn" style="background: #10b981; color: white;" onclick="toggleAnimation()">
                        <span id="animToggleText">â¸ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢<br><span style="font-size: 0.8em; opacity: 0.8;">Stop Animation</span></span>
                    </button>
                    <button class="btn" style="background: #8b5cf6; color: white;" onclick="resetView()">
                        ğŸ¯ å…¨ä½“è¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ<br><span style="font-size: 0.8em; opacity: 0.8;">Reset View</span>
                    </button>
                </div>
            </div>

            <div class="info-panel">
                <div class="info-title" id="regionTitle">é–¢æ±åœã¸ã®æµå…¥çµ±è¨ˆ</div>
                <div class="info-content" id="areaInfo">
                    éƒŠå¤–ã‹ã‚‰ä¸»è¦éƒ½å¸‚éƒ¨ã¸ã®é€šå‹¤æµå‹•ã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚
                </div>
                
                <div class="stats-grid" id="totalStatsGrid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalInFlow">197ä¸‡</div>
                        <div class="stat-label" id="totalLabel">ç·æµå…¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeFlows">10</div>
                        <div class="stat-label">æ´»ç™ºãªæµå‹•</div>
                    </div>
                </div>
                
                <div class="stats-grid" id="statsGrid" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="inFlow">-</div>
                        <div class="stat-label">æµå…¥äººå£</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="outFlow">-</div>
                        <div class="stat-label">æµå‡ºäººå£</div>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h3 id="congestionTitle">ğŸš‡ é–¢æ±åœ æ··é›‘è·¯ç·šãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div id="congestionRanking" class="congestion-ranking">
                    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>

            <div class="legend">
                <h3>ğŸ¨ éƒ½å¸‚åœæµå…¥ãƒ¬ãƒ™ãƒ«</h3>
                <div style="margin-bottom: 1.5rem;">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444; height: 10px; box-shadow: 0 0 8px #ef4444;"></div>
                        <span><strong>ğŸ”¥ è¶…å¤§è¦æ¨¡å—ã‘å…¥ã‚Œ</strong><br>30ä¸‡äººä»¥ä¸Š</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f97316; height: 8px; box-shadow: 0 0 6px #f97316;"></div>
                        <span><strong>ğŸ”´ å¤§è¦æ¨¡å—ã‘å…¥ã‚Œ</strong><br>20ã€œ30ä¸‡äºº</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #eab308; height: 6px; box-shadow: 0 0 4px #eab308;"></div>
                        <span><strong>ğŸŸ¡ ä¸­è¦æ¨¡å—ã‘å…¥ã‚Œ</strong><br>10ã€œ20ä¸‡äºº</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22c55e; height: 4px; box-shadow: 0 0 3px #22c55e;"></div>
                        <span><strong>ğŸŸ¢ å°è¦æ¨¡å—ã‘å…¥ã‚Œ</strong><br>10ä¸‡äººæœªæº€</span>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem;">éƒŠå¤–â†’éƒ½å¸‚éƒ¨æµå…¥</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444; height: 3px; opacity: 0.7;"></div>
                    <span>4ä¸‡äººä»¥ä¸Š</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f97316; height: 3px; opacity: 0.7;"></div>
                    <span>3ã€œ4ä¸‡äºº</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #eab308; height: 3px; opacity: 0.7;"></div>
                    <span>2ã€œ3ä¸‡äºº</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #22c55e; height: 3px; opacity: 0.7;"></div>
                    <span>1ã€œ2ä¸‡äºº</span>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.9em; margin-bottom: 0.5rem;"><strong>ğŸ“ è¡¨ç¤ºå†…å®¹</strong></div>
                    <div style="font-size: 0.8em; color: #666;">
                        âšª å††ï¼šå—ã‘å…¥ã‚Œè¦æ¨¡<br>
                        ã€°ï¸ æ›²ç·šï¼šéƒŠå¤–ã‹ã‚‰ã®æµå…¥<br>
                        ğŸ”º çŸ¢å°ï¼šæµå‹•æ–¹å‘<br>
                        âšª ç‚¹ï¼šäººã®å‹•ã<br>
                        ğŸ’¬ ã‚¯ãƒªãƒƒã‚¯ï¼šè©³ç´°æƒ…å ±
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // åœ°å›³ã®åˆæœŸåŒ–
        let map;
        let currentLayer = null;
        
        // å…¨å›½ä¸»è¦éƒ½å¸‚åœã®é€šå‹¤æµå‹•ãƒ‡ãƒ¼ã‚¿
        const regionalData = {
            // é–¢æ±åœï¼ˆæ±äº¬23åŒºä¸­å¿ƒï¼‰
            kanto: {
                name: "é–¢æ±åœ",
                center: [35.6762, 139.6503],
                zoom: 9,
                boundary: [
                    [35.5397, 139.4576], [35.5397, 139.8701], [35.7885, 139.8701], [35.7885, 139.4576], [35.5397, 139.4576]
                ],
                mainAreas: [
                    { name: "åƒä»£ç”°åŒº", center: [35.6939, 139.7030], totalInflow: 420000 },
                    { name: "æ¸¯åŒº", center: [35.6581, 139.7414], totalInflow: 350000 },
                    { name: "æ–°å®¿åŒº", center: [35.6895, 139.6917], totalInflow: 285000 },
                    { name: "æ¸‹è°·åŒº", center: [35.6762, 139.6503], totalInflow: 220000 },
                    { name: "ä¸­å¤®åŒº", center: [35.6762, 139.7731], totalInflow: 190000 },
                    { name: "è±Šå³¶åŒº", center: [35.7295, 139.7109], totalInflow: 180000 },
                    { name: "å“å·åŒº", center: [35.6284, 139.7387], totalInflow: 160000 },
                    { name: "æ±Ÿæ±åŒº", center: [35.6682, 139.8171], totalInflow: 140000 }
                ],
                inflowData: [
                    { from: [35.8617, 139.6455], fromName: "åŸ¼ç‰çœŒã•ã„ãŸã¾å¸‚", toArea: "æ–°å®¿åŒº", volume: 45000 },
                    { from: [35.7065, 140.1032], fromName: "åƒè‘‰çœŒèˆ¹æ©‹å¸‚", toArea: "åƒä»£ç”°åŒº", volume: 48000 },
                    { from: [35.4437, 139.6380], fromName: "ç¥å¥ˆå·çœŒå·å´å¸‚", toArea: "å“å·åŒº", volume: 42000 },
                    { from: [35.4508, 139.6425], fromName: "ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚", toArea: "æ¸‹è°·åŒº", volume: 28000 },
                    { from: [35.7595, 139.4778], fromName: "æ±äº¬éƒ½ç«‹å·å¸‚", toArea: "æ–°å®¿åŒº", volume: 35000 },
                    { from: [36.0834, 140.1167], fromName: "èŒ¨åŸçœŒã¤ãã°å¸‚", toArea: "åƒä»£ç”°åŒº", volume: 25000 },
                    { from: [35.8617, 139.6455], fromName: "åŸ¼ç‰çœŒã•ã„ãŸã¾å¸‚", toArea: "è±Šå³¶åŒº", volume: 38000 },
                    { from: [35.4437, 139.6380], fromName: "ç¥å¥ˆå·çœŒå·å´å¸‚", toArea: "æ¸¯åŒº", volume: 35000 },
                    { from: [35.7065, 140.1032], fromName: "åƒè‘‰çœŒèˆ¹æ©‹å¸‚", toArea: "ä¸­å¤®åŒº", volume: 35000 },
                    { from: [35.6587, 139.5466], fromName: "æ±äº¬éƒ½ä¸‰é·¹å¸‚", toArea: "æ–°å®¿åŒº", volume: 18000 }
                ],
                congestionRanking: [
                    { rank: 1, line: "JRæ±æµ·é“ç·š", section: "å·å´â†’å“å·", congestion: 197, passengers: "85ä¸‡äºº" },
                    { rank: 2, line: "JRä¸­å¤®ç·šå¿«é€Ÿ", section: "ä¸­é‡â†’æ–°å®¿", congestion: 193, passengers: "75ä¸‡äºº" },
                    { rank: 3, line: "JRç·æ­¦ç·šå„åœ", section: "éŒ¦ç³¸ç”ºâ†’ä¸¡å›½", congestion: 192, passengers: "68ä¸‡äºº" },
                    { rank: 4, line: "JRäº¬æµœæ±åŒ—ç·š", section: "å¤§äº•ç”ºâ†’å“å·", congestion: 188, passengers: "72ä¸‡äºº" },
                    { rank: 5, line: "æ±äº¬ãƒ¡ãƒˆãƒ­æ±è¥¿ç·š", section: "æœ¨å ´â†’é–€å‰ä»²ç”º", congestion: 186, passengers: "64ä¸‡äºº" },
                    { rank: 6, line: "JRå±±æ‰‹ç·š", section: "ä¸Šé‡â†’å¾¡å¾’ç”º", congestion: 184, passengers: "58ä¸‡äºº" },
                    { rank: 7, line: "å°ç”°æ€¥ç·š", section: "ä¸–ç”°è°·ä»£ç”°â†’ä¸‹åŒ—æ²¢", congestion: 182, passengers: "52ä¸‡äºº" },
                    { rank: 8, line: "æ±æ€¥ç”°åœ’éƒ½å¸‚ç·š", section: "æ± å°»å¤§æ©‹â†’æ¸‹è°·", congestion: 181, passengers: "61ä¸‡äºº" }
                ]
            },
            
            // ä¸­éƒ¨åœï¼ˆåå¤å±‹ä¸­å¿ƒï¼‰
            chubu: {
                name: "ä¸­éƒ¨åœ",
                center: [35.1815, 136.9066],
                zoom: 11,
                boundary: [
                    [35.0500, 136.7500], [35.0500, 137.0500], [35.3000, 137.0500], [35.3000, 136.7500], [35.0500, 136.7500]
                ],
                mainAreas: [
                    { name: "ä¸­åŒº", center: [35.1681, 136.9066], totalInflow: 180000 },
                    { name: "ä¸­æ‘åŒº", center: [35.1698, 136.8704], totalInflow: 150000 },
                    { name: "æ±åŒº", center: [35.1794, 136.9239], totalInflow: 120000 },
                    { name: "è¥¿åŒº", center: [35.1894, 136.8739], totalInflow: 110000 },
                    { name: "åƒç¨®åŒº", center: [35.1649, 136.9422], totalInflow: 95000 },
                    { name: "ç†±ç”°åŒº", center: [35.1282, 136.9095], totalInflow: 85000 }
                ],
                inflowData: [
                    { from: [35.0275, 136.9709], fromName: "æ„›çŸ¥çœŒè±Šç”°å¸‚", toArea: "ä¸­åŒº", volume: 25000 },
                    { from: [34.8872, 136.8791], fromName: "æ„›çŸ¥çœŒå²¡å´å¸‚", toArea: "ä¸­åŒº", volume: 18000 },
                    { from: [35.1043, 136.8551], fromName: "æ„›çŸ¥çœŒä¸€å®®å¸‚", toArea: "ä¸­æ‘åŒº", volume: 22000 },
                    { from: [35.2431, 136.9716], fromName: "æ„›çŸ¥çœŒæ˜¥æ—¥äº•å¸‚", toArea: "æ±åŒº", volume: 20000 },
                    { from: [35.3273, 136.8738], fromName: "å²é˜œçœŒå²é˜œå¸‚", toArea: "ä¸­æ‘åŒº", volume: 15000 },
                    { from: [34.9767, 137.0380], fromName: "ä¸‰é‡çœŒå››æ—¥å¸‚å¸‚", toArea: "ä¸­åŒº", volume: 12000 },
                    { from: [35.2273, 136.8610], fromName: "æ„›çŸ¥çœŒå°ç‰§å¸‚", toArea: "è¥¿åŒº", volume: 14000 },
                    { from: [35.1435, 136.7754], fromName: "æ„›çŸ¥çœŒç¨²æ²¢å¸‚", toArea: "åƒç¨®åŒº", volume: 10000 }
                ],
                congestionRanking: [
                    { rank: 1, line: "JRæ±æµ·é“ç·š", section: "é‡‘å±±â†’åå¤å±‹", congestion: 168, passengers: "45ä¸‡äºº" },
                    { rank: 2, line: "åé‰„åå¤å±‹ç·š", section: "ç¥å®®å‰â†’é‡‘å±±", congestion: 165, passengers: "38ä¸‡äºº" },
                    { rank: 3, line: "JRä¸­å¤®ç·š", section: "é¶´èˆâ†’åå¤å±‹", congestion: 162, passengers: "35ä¸‡äºº" },
                    { rank: 4, line: "åœ°ä¸‹é‰„æ±å±±ç·š", section: "ä»Šæ± â†’æ „", congestion: 158, passengers: "42ä¸‡äºº" },
                    { rank: 5, line: "åé‰„è±Šç”°ç·š", section: "èµ¤æ± â†’ä¼è¦‹", congestion: 155, passengers: "28ä¸‡äºº" },
                    { rank: 6, line: "åœ°ä¸‹é‰„ååŸç·š", section: "çŸ¢å ´ç”ºâ†’æ „", congestion: 152, passengers: "32ä¸‡äºº" }
                ]
            },
            
            // é–¢è¥¿åœï¼ˆå¤§é˜ªä¸­å¿ƒï¼‰
            kansai: {
                name: "é–¢è¥¿åœ",
                center: [34.6937, 135.5023],
                zoom: 11,
                boundary: [
                    [34.5500, 135.3500], [34.5500, 135.7500], [34.8500, 135.7500], [34.8500, 135.3500], [34.5500, 135.3500]
                ],
                mainAreas: [
                    { name: "æ¢…ç”°ãƒ»åŒ—åŒº", center: [34.7024, 135.4959], totalInflow: 280000 },
                    { name: "é›£æ³¢ãƒ»ä¸­å¤®åŒº", center: [34.6741, 135.5007], totalInflow: 250000 },
                    { name: "å¤©ç‹å¯ºãƒ»å¤©ç‹å¯ºåŒº", center: [34.6460, 135.5066], totalInflow: 180000 },
                    { name: "æœ¬ç”ºãƒ»è¥¿åŒº", center: [34.6826, 135.4932], totalInflow: 160000 },
                    { name: "æ–°å¤§é˜ªãƒ»æ·€å·åŒº", center: [34.7326, 135.5009], totalInflow: 140000 },
                    { name: "ä½å‰åŒº", center: [34.6138, 135.4951], totalInflow: 120000 }
                ],
                inflowData: [
                    { from: [34.8113, 135.4669], fromName: "å…µåº«çœŒå°¼å´å¸‚", toArea: "æ¢…ç”°ãƒ»åŒ—åŒº", volume: 35000 },
                    { from: [34.8456, 135.6303], fromName: "å…µåº«çœŒè¥¿å®®å¸‚", toArea: "æ¢…ç”°ãƒ»åŒ—åŒº", volume: 28000 },
                    { from: [34.5706, 135.4769], fromName: "å¥ˆè‰¯çœŒå¥ˆè‰¯å¸‚", toArea: "é›£æ³¢ãƒ»ä¸­å¤®åŒº", volume: 22000 },
                    { from: [34.7305, 135.3439], fromName: "å…µåº«çœŒç¥æˆ¸å¸‚", toArea: "æ¢…ç”°ãƒ»åŒ—åŒº", volume: 45000 },
                    { from: [34.8034, 135.7728], fromName: "äº¬éƒ½åºœäº¬éƒ½å¸‚", toArea: "æ¢…ç”°ãƒ»åŒ—åŒº", volume: 32000 },
                    { from: [34.5708, 135.6383], fromName: "å’Œæ­Œå±±çœŒå’Œæ­Œå±±å¸‚", toArea: "å¤©ç‹å¯ºãƒ»å¤©ç‹å¯ºåŒº", volume: 18000 },
                    { from: [34.6760, 135.8361], fromName: "äº¬éƒ½åºœå®‡æ²»å¸‚", toArea: "æœ¬ç”ºãƒ»è¥¿åŒº", volume: 16000 },
                    { from: [34.8859, 135.5394], fromName: "å…µåº«çœŒå®å¡šå¸‚", toArea: "æ–°å¤§é˜ªãƒ»æ·€å·åŒº", volume: 12000 }
                ],
                congestionRanking: [
                    { rank: 1, line: "JRå¤§é˜ªç’°çŠ¶ç·š", section: "è¥¿ä¹æ¡â†’å¤§é˜ª", congestion: 175, passengers: "58ä¸‡äºº" },
                    { rank: 2, line: "é˜ªæ€¥ç¥æˆ¸ç·š", section: "åä¸‰â†’æ¢…ç”°", congestion: 172, passengers: "52ä¸‡äºº" },
                    { rank: 3, line: "JRæ±æµ·é“ç·š", section: "æ–°å¤§é˜ªâ†’å¤§é˜ª", congestion: 169, passengers: "48ä¸‡äºº" },
                    { rank: 4, line: "åœ°ä¸‹é‰„å¾¡å ‚ç­‹ç·š", section: "æ·€å±‹æ©‹â†’æ¢…ç”°", congestion: 166, passengers: "65ä¸‡äºº" },
                    { rank: 5, line: "é˜ªæ€¥å®å¡šç·š", section: "åä¸‰â†’æ¢…ç”°", congestion: 163, passengers: "42ä¸‡äºº" },
                    { rank: 6, line: "äº¬é˜ªæœ¬ç·š", section: "äº¬æ©‹â†’æ·€å±‹æ©‹", congestion: 160, passengers: "38ä¸‡äºº" },
                    { rank: 7, line: "è¿‘é‰„å¥ˆè‰¯ç·š", section: "é¶´æ©‹â†’å¤§é˜ªé›£æ³¢", congestion: 158, passengers: "35ä¸‡äºº" }
                ]
            },
            
            // ç¦å²¡åœ
            fukuoka: {
                name: "ç¦å²¡åœ",
                center: [33.5904, 130.4017],
                zoom: 12,
                boundary: [
                    [33.4500, 130.2500], [33.4500, 130.5500], [33.7500, 130.5500], [33.7500, 130.2500], [33.4500, 130.2500]
                ],
                mainAreas: [
                    { name: "åšå¤šåŒº", center: [33.5906, 130.4137], totalInflow: 180000 },
                    { name: "ä¸­å¤®åŒº", center: [33.5858, 130.3947], totalInflow: 160000 },
                    { name: "æ—©è‰¯åŒº", center: [33.5669, 130.3541], totalInflow: 120000 },
                    { name: "å—åŒº", center: [33.5544, 130.4180], totalInflow: 110000 },
                    { name: "è¥¿åŒº", center: [33.5638, 130.3257], totalInflow: 95000 },
                    { name: "æ±åŒº", center: [33.6153, 130.4214], totalInflow: 85000 }
                ],
                inflowData: [
                    { from: [33.6068, 130.5186], fromName: "ç¦å²¡çœŒä¹…ç•™ç±³å¸‚", toArea: "åšå¤šåŒº", volume: 25000 },
                    { from: [33.7295, 130.4479], fromName: "ç¦å²¡çœŒé£¯å¡šå¸‚", toArea: "åšå¤šåŒº", volume: 18000 },
                    { from: [33.5127, 130.5590], fromName: "ç¦å²¡çœŒå¤§é‡åŸå¸‚", toArea: "ä¸­å¤®åŒº", volume: 22000 },
                    { from: [33.8141, 130.7181], fromName: "ç¦å²¡çœŒåŒ—ä¹å·å¸‚", toArea: "åšå¤šåŒº", volume: 35000 },
                    { from: [33.2197, 130.2985], fromName: "ä½è³€çœŒä½è³€å¸‚", toArea: "åšå¤šåŒº", volume: 15000 },
                    { from: [32.7898, 130.7417], fromName: "ç†Šæœ¬çœŒç†Šæœ¬å¸‚", toArea: "åšå¤šåŒº", volume: 12000 },
                    { from: [33.5802, 130.2432], fromName: "ç¦å²¡çœŒç³¸å³¶å¸‚", toArea: "è¥¿åŒº", volume: 14000 },
                    { from: [33.6501, 130.4408], fromName: "ç¦å²¡çœŒæ˜¥æ—¥å¸‚", toArea: "å—åŒº", volume: 16000 }
                ],
                congestionRanking: [
                    { rank: 1, line: "JRé¹¿å…å³¶ç·š", section: "å—ç¦å²¡â†’åšå¤š", congestion: 152, passengers: "32ä¸‡äºº" },
                    { rank: 2, line: "è¥¿é‰„å¤©ç¥å¤§ç‰Ÿç”°ç·š", section: "è¥¿é‰„ç¦å²¡â†’è–¬é™¢", congestion: 148, passengers: "28ä¸‡äºº" },
                    { rank: 3, line: "åœ°ä¸‹é‰„ç©ºæ¸¯ç·š", section: "åšå¤šâ†’å¤©ç¥", congestion: 145, passengers: "35ä¸‡äºº" },
                    { rank: 4, line: "JRç¦åŒ—ã‚†ãŸã‹ç·š", section: "å‰å¡šâ†’åšå¤š", congestion: 142, passengers: "22ä¸‡äºº" },
                    { rank: 5, line: "åœ°ä¸‹é‰„ç®±å´ç·š", section: "å‘‰æœç”ºâ†’ä¸­æ´²å·ç«¯", congestion: 138, passengers: "18ä¸‡äºº" }
                ]
            }
        };
        
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®åœ°åŸŸãƒ‡ãƒ¼ã‚¿
        let currentRegion = 'kanto';
        let commuteData = regionalData[currentRegion];

        function initMap() {
            // åœ°å›³ã®ä½œæˆï¼ˆç¾åœ¨ã®åœ°åŸŸä¸­å¿ƒï¼‰
            map = L.map('map').setView(commuteData.center, commuteData.zoom);

            // OpenStreetMap ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            document.getElementById('loading').style.display = 'none';
            
            // åˆæœŸè¡¨ç¤ºã¯é€šå‹¤æµå‹•
            showCommuteFlow();
        }

        function showCommuteFlow() {
            clearLayer();
            
            const flowLayer = L.layerGroup();
            
            // ä¸»è¦å—ã‘å…¥ã‚Œã‚¨ãƒªã‚¢ã‚’å††ã§è¡¨ç¤ºï¼ˆæµå…¥æ•°ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºå¤‰æ›´ï¼‰
            commuteData.mainAreas.forEach(area => {
                const radius = Math.sqrt(area.totalInflow) * 12; // æµå…¥æ•°ã«å¿œã˜ãŸã‚µã‚¤ã‚º
                let color;
                
                if (area.totalInflow >= 300000) color = '#ef4444'; // è¶…å¤§è¦æ¨¡
                else if (area.totalInflow >= 200000) color = '#f97316'; // å¤§è¦æ¨¡
                else if (area.totalInflow >= 100000) color = '#eab308'; // ä¸­è¦æ¨¡
                else color = '#22c55e'; // å°è¦æ¨¡
                
                const circle = L.circle(area.center, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.3,
                    radius: radius,
                    weight: 3
                }).addTo(flowLayer);
                
                // æµå…¥æ•°ã‚’è¡¨ç¤ºã™ã‚‹ãƒ©ãƒ™ãƒ«
                const labelIcon = L.divIcon({
                    html: `<div style="
                        background: white;
                        border: 3px solid ${color};
                        color: ${color};
                        padding: 8px 12px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: 900;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        white-space: nowrap;
                    ">${area.name}<br>${(area.totalInflow / 10000).toFixed(1)}ä¸‡äºº</div>`,
                    className: 'area-label',
                    iconSize: [80, 40],
                    iconAnchor: [40, 20]
                });
                
                L.marker(area.center, { icon: labelIcon }).addTo(flowLayer)
                    .bindPopup(`
                        <div class="responsive-popup" style="text-align: center; padding: 12px; max-width: 280px;">
                            <h3 style="margin: 0 0 8px 0; color: ${color}; font-size: 1.1rem;">ğŸ¢ ${area.name}</h3>
                            <div style="background: ${color}; color: white; padding: 12px; border-radius: 8px;">
                                <div style="font-size: 1.6em; font-weight: bold; margin-bottom: 4px;">
                                    ${area.totalInflow.toLocaleString()}äºº
                                </div>
                                <div style="font-size: 0.9em;">æ¯æ—¥ã®æµå…¥äººå£<br><span style="font-size: 0.85em; opacity: 0.9;">Daily Inflow Population</span></div>
                            </div>
                            <div style="margin: 8px 0; font-size: 0.85em; color: #666; line-height: 1.3;">
                                ${area.totalInflow >= 400000 ? 'ğŸ”¥ è¶…å¤§è¦æ¨¡å—ã‘å…¥ã‚Œåœ°åŸŸ | Ultra-large Reception Area' : 
                                  area.totalInflow >= 300000 ? 'ğŸ”´ å¤§è¦æ¨¡å—ã‘å…¥ã‚Œåœ°åŸŸ | Large Reception Area' : 
                                  area.totalInflow >= 200000 ? 'ğŸŸ¡ ä¸­è¦æ¨¡å—ã‘å…¥ã‚Œåœ°åŸŸ | Medium Reception Area' : 'ğŸŸ¢ å°è¦æ¨¡å—ã‘å…¥ã‚Œåœ°åŸŸ | Small Reception Area'}
                            </div>
                        </div>
                    `);
                
                circle.on('click', () => {
                    updateAreaInfo({ name: area.name, inFlow: area.totalInflow, outFlow: 0 });
                });
            });
            
            // éƒŠå¤–ã‹ã‚‰ä¸»è¦éƒ½å¸‚éƒ¨ã¸ã®æµå…¥ç·šã‚’æç”»ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
            commuteData.inflowData.forEach((flow, index) => {
                const volume = flow.volume;
                let color, weight;
                
                if (volume >= 40000) {
                    color = '#ef4444';
                    weight = 6;
                } else if (volume >= 30000) {
                    color = '#f97316';
                    weight = 4;
                } else if (volume >= 20000) {
                    color = '#eab308';
                    weight = 3;
                } else {
                    color = '#22c55e';
                    weight = 2;
                }
                
                // åˆ°ç€åœ°ã®åº§æ¨™ã‚’å–å¾—
                const toArea = commuteData.mainAreas.find(area => area.name === flow.toArea);
                if (!toArea) {
                    console.log(`æµå‹•ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: ${flow.toArea} ãŒ mainAreas ã§è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, flow);
                    return;
                }
                
                // æ›²ç·šçŠ¶ã®ãƒ‘ã‚¹ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
                const midPoint = [
                    (flow.from[0] + toArea.center[0]) / 2 + (Math.random() - 0.5) * 0.02,
                    (flow.from[1] + toArea.center[1]) / 2 + (Math.random() - 0.5) * 0.02
                ];
                
                const curve = L.polyline([flow.from, midPoint, toArea.center], {
                    color: color,
                    weight: weight,
                    opacity: 0.7,
                    className: `flow-line flow-${index}`
                }).addTo(flowLayer);
                
                // æµå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‹•ãç‚¹ï¼‰ã‚’è¿½åŠ 
                createFlowingDots(flow.from, midPoint, toArea.center, color, flowLayer, index, weight);
                
                // æ–¹å‘ã‚’ç¤ºã™çŸ¢å°
                const angle = calculateAngle(midPoint, toArea.center);
                const arrowSize = Math.max(16, weight + 8);
                const arrowIcon = L.divIcon({
                    html: `<div style="
                        transform: rotate(${angle}deg);
                        font-size: ${arrowSize}px;
                        color: ${color};
                        font-weight: 900;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
                        filter: drop-shadow(0 0 6px ${color});
                        animation: arrowPulse 2s infinite;
                    ">ğŸ”º</div>`,
                    className: 'flow-arrow',
                    iconSize: [arrowSize + 4, arrowSize + 4],
                    iconAnchor: [arrowSize/2 + 2, arrowSize/2 + 2]
                });
                
                L.marker(toArea.center, { icon: arrowIcon }).addTo(flowLayer);
                
                // æµå‹•é‡ã‚’æ•°å­—ã§è¡¨ç¤ºï¼ˆç·šã®ä¸­å¤®ä»˜è¿‘ï¼‰
                const labelPosition = [
                    (flow.from[0] + midPoint[0]) / 2,
                    (flow.from[1] + midPoint[1]) / 2
                ];
                
                const labelSize = Math.max(10, weight * 1.2);
                const labelIcon = L.divIcon({
                    html: `<div style="
                        background: ${color};
                        color: white;
                        padding: 3px 6px;
                        border-radius: 12px;
                        font-size: ${labelSize}px;
                        font-weight: 900;
                        text-align: center;
                        border: 2px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                        white-space: nowrap;
                        animation: numberPulse 3s infinite;
                    ">${(flow.volume / 10000).toFixed(1)}ä¸‡</div>`,
                    className: 'flow-number',
                    iconSize: [labelSize * 3, labelSize + 6],
                    iconAnchor: [labelSize * 1.5, labelSize/2 + 3]
                });
                
                L.marker(labelPosition, { icon: labelIcon }).addTo(flowLayer);
                
                // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                curve.bindPopup(`
                    <div class="responsive-popup" style="text-align: center; padding: 10px; min-width: 180px; max-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; color: ${color}; font-size: 1rem; line-height: 1.3;">
                            ${flow.fromName} â†’ ${flow.toArea}
                        </h3>
                        <div style="background: ${color}; color: white; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 2px;">
                                ${flow.volume.toLocaleString()}äºº/æ—¥
                            </div>
                            <div style="font-size: 0.8em; opacity: 0.9;">
                                ${flow.volume.toLocaleString()} people/day
                            </div>
                        </div>
                        <div style="margin: 8px 0; font-size: 0.8em; color: #666; line-height: 1.3;">
                            ${volume >= 40000 ? 'ğŸ”¥ è¶…å¤§è¦æ¨¡æµå…¥ | Ultra-large Flow' : 
                              volume >= 30000 ? 'ğŸ”´ å¤§è¦æ¨¡æµå…¥ | Large Flow' : 
                              volume >= 20000 ? 'ğŸŸ¡ ä¸­è¦æ¨¡æµå…¥ | Medium Flow' : 'ğŸŸ¢ å°è¦æ¨¡æµå…¥ | Small Flow'}
                        </div>
                    </div>
                `);
                
                // å‡ºç™ºåœ°ã®ç°¡å˜ãªãƒãƒ¼ã‚«ãƒ¼
                const startIcon = L.divIcon({
                    html: `<div style="
                        background: ${color};
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    "></div>`,
                    className: 'simple-start-marker',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                
                L.marker(flow.from, { icon: startIcon }).addTo(flowLayer)
                    .bindPopup(`
                        <div class="responsive-popup" style="text-align: center; padding: 8px; max-width: 200px;">
                            <strong style="font-size: 0.9rem;">${flow.fromName}</strong><br>
                            <div style="color: #666; font-size: 0.8em; line-height: 1.3; margin-top: 4px;">
                                ${flow.toArea}ã¸ ${flow.volume.toLocaleString()}äººãŒé€šå‹¤<br>
                                <span style="font-size: 0.85em;">Daily commuters to ${flow.toArea}: ${flow.volume.toLocaleString()}</span>
                            </div>
                        </div>
                    `);
            });
            
            // åœ°åŸŸå…¨ä½“ã‚¨ãƒªã‚¢ã®å¯è¦–åŒ–
            addRegionBoundaryVisualization(flowLayer);
            
            // åœ°åŸŸå…¨ä½“ã®æµå…¥çµ±è¨ˆã‚’è¨ˆç®—ãƒ»æ›´æ–°
            updateTotalInflowStats();
            
            currentLayer = flowLayer;
            flowLayer.addTo(map);
        }
        
        function updateTotalInflowStats() {
            // åœ°åŸŸå…¨ä½“ã®ç·æµå…¥æ•°ã‚’è¨ˆç®—
            const totalInflow = commuteData.mainAreas.reduce((sum, area) => sum + area.totalInflow, 0);
            // æ´»ç™ºãªæµå‹•æ•°ï¼ˆå€‹åˆ¥æµå…¥ãƒ‡ãƒ¼ã‚¿ã®æ•°ï¼‰
            const activeFlowCount = commuteData.inflowData.length;
            
            // çµ±è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('totalInFlow').textContent = (totalInflow / 10000).toFixed(0) + 'ä¸‡';
            document.getElementById('activeFlows').textContent = activeFlowCount;
            
            // åœ°åŸŸåã‚’æ›´æ–°
            document.getElementById('regionTitle').textContent = commuteData.name + 'ã¸ã®æµå…¥çµ±è¨ˆ';
            
            // æ··é›‘ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
            updateCongestionRanking();
        }
        
        function updateCongestionRanking() {
            const rankingContainer = document.getElementById('congestionRanking');
            const titleElement = document.getElementById('congestionTitle');
            
            // åœ°åŸŸã”ã®ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            const regionIcons = {
                kanto: 'ğŸ—¼',
                chubu: 'ğŸ¯', 
                kansai: 'ğŸ°',
                fukuoka: 'ğŸ®'
            };
            
            titleElement.textContent = `ğŸš‡ ${commuteData.name} æ··é›‘è·¯ç·šãƒ©ãƒ³ã‚­ãƒ³ã‚°`;
            
            if (!commuteData.congestionRanking) {
                rankingContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">ã“ã®åœ°åŸŸã®æ··é›‘ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨åé›†ä¸­ã§ã™</div>';
                return;
            }
            
            let html = '';
            commuteData.congestionRanking.forEach(item => {
                // æ··é›‘åº¦ã«ã‚ˆã‚‹åˆ†é¡
                let congestionClass = 'low';
                if (item.congestion >= 180) congestionClass = 'extreme';
                else if (item.congestion >= 170) congestionClass = 'high';
                else if (item.congestion >= 160) congestionClass = 'medium';
                
                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³
                let rankIcon = item.rank;
                if (item.rank === 1) rankIcon = 'ğŸ¥‡';
                else if (item.rank === 2) rankIcon = 'ğŸ¥ˆ';
                else if (item.rank === 3) rankIcon = 'ğŸ¥‰';
                
                html += `
                    <div class="congestion-item ${congestionClass}">
                        <div class="congestion-rank">${rankIcon}</div>
                        <div class="congestion-info">
                            <div class="congestion-line">${item.line}</div>
                            <div class="congestion-section">${item.section}</div>
                            <div class="congestion-stats">
                                <span class="congestion-rate">${item.congestion}%</span>
                                <span class="congestion-passengers">${item.passengers}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            rankingContainer.innerHTML = html;
        }
        
        function addRegionBoundaryVisualization(layer) {
            // åœ°åŸŸã®å¢ƒç•Œã‚’è¡¨ç¤º
            const boundaryPolygon = L.polygon(commuteData.boundary, {
                color: '#667eea',
                weight: 3,
                opacity: 0.8,
                fillColor: '#667eea',
                fillOpacity: 0.1,
                dashArray: '15,10'
            }).addTo(layer);
            
            // åœ°åŸŸä¸­å¤®ã«ç·æµå…¥æ•°ã‚’è¡¨ç¤ºï¼ˆé–¢æ±ã®å ´åˆã¯é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ä½ç½®èª¿æ•´ï¼‰
            let centralPoint = commuteData.center;
            if (currentRegion === 'kanto') {
                centralPoint = [35.7600, 139.5500]; // é–¢æ±ã¯åŒ—è¥¿ã®ç©ºã„ã¦ã„ã‚‹ã‚¨ãƒªã‚¢ã«é…ç½®
            }
            const totalInflow = commuteData.mainAreas.reduce((sum, area) => sum + area.totalInflow, 0);
            
            // åœ°åŸŸã”ã¨ã®ã‚¢ã‚¤ã‚³ãƒ³
            const regionIcons = {
                kanto: 'ğŸ—¼',
                chubu: 'ğŸ¯', 
                kansai: 'ğŸ°',
                fukuoka: 'ğŸ®'
            };
            
            const centralIcon = L.divIcon({
                html: `<div style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: 900;
                    text-align: center;
                    border: 4px solid white;
                    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                    white-space: nowrap;
                    animation: megaPulse 4s infinite;
                ">${regionIcons[currentRegion]} ${commuteData.name}<br>ç·æµå…¥ ${(totalInflow / 10000).toFixed(0)}ä¸‡äºº/æ—¥</div>`,
                className: 'central-total-label',
                iconSize: [160, 50],
                iconAnchor: [80, 25]
            });
            
            // åœ°åŸŸã®ä¸»è¦ã‚¨ãƒªã‚¢åï¼ˆæœ€å¤§3ã¤ï¼‰
            const topAreas = commuteData.mainAreas
                .sort((a, b) => b.totalInflow - a.totalInflow)
                .slice(0, 3)
                .map(area => `${area.name} (${(area.totalInflow / 10000).toFixed(1)}ä¸‡)`)
                .join(' â€¢ ');
            
            L.marker(centralPoint, { icon: centralIcon }).addTo(layer)
                .bindPopup(`
                    <div style="text-align: center; padding: 15px;">
                        <h2 style="margin: 0 0 15px 0; color: #667eea;">${regionIcons[currentRegion]} ${commuteData.name} å…¨ä½“çµ±è¨ˆ</h2>
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 8px;">
                                ${(totalInflow / 10000).toFixed(0)}ä¸‡äºº
                            </div>
                            <div style="font-size: 1.1em; opacity: 0.9;">æ¯æ—¥ã®ç·æµå…¥äººå£<br><span style="font-size: 0.9em;">Daily Total Inflow Population</span></div>
                        </div>
                        <div style="margin: 15px 0; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                            <div style="font-size: 0.9em; color: #666;">
                                <strong>ä¸»è¦å—ã‘å…¥ã‚Œåœ°åŸŸ | Major Reception Areas:</strong><br>
                                ${topAreas}
                            </div>
                        </div>
                        <div style="font-size: 0.85em; color: #888;">
                            ğŸ’¡ å„ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º<br>
                            <span style="font-size: 0.9em;">Click each area for details</span>
                        </div>
                    </div>
                `);
            
            boundaryPolygon.bindPopup(`
                <div style="text-align: center; padding: 12px;">
                    <h3 style="margin: 0 0 10px 0; color: #667eea;">ğŸ—ºï¸ ${commuteData.name}ã‚¨ãƒªã‚¢</h3>
                    <div style="background: #667eea; color: white; padding: 12px; border-radius: 8px;">
                        <div><strong>æ¯æ—¥ã®æµå…¥: ${(totalInflow / 10000).toFixed(0)}ä¸‡äºº | Daily Inflow: ${(totalInflow / 10000).toFixed(0)}0K</strong></div>
                        <div>æ´»ç™ºãªæµå‹•: ${commuteData.inflowData.length}ãƒ«ãƒ¼ãƒˆ | Active Flows: ${commuteData.inflowData.length} routes</div>
                    </div>
                </div>
            `);
        }
        
        function switchRegion(region) {
            currentRegion = region;
            commuteData = regionalData[region];
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn');
            });
            document.getElementById(`btn-${region}`).classList.add('btn-primary');
            
            // åœ°å›³ã®è¡¨ç¤ºã‚’æ›´æ–°
            map.setView(commuteData.center, commuteData.zoom);
            showCommuteFlow();
        }


        function updateAreaInfo(area) {
            document.getElementById('areaInfo').innerHTML = `
                <strong>${area.name}ã®é€šå‹¤æµå‹•</strong><br>
                ã“ã®åœ°åŸŸã®è©³ç´°ãªäººã®æµã‚Œãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br>
                <span style="font-size: 0.9em; opacity: 0.8;">Displaying detailed commuter flow data for this area.</span>
            `;
            
            document.getElementById('inFlow').textContent = area.inFlow.toLocaleString();
            document.getElementById('outFlow').textContent = area.outFlow.toLocaleString();
            document.getElementById('statsGrid').style.display = 'grid';
        }

        function clearLayer() {
            if (currentLayer) {
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
                stopAllAnimations();
                
                // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
                map.removeLayer(currentLayer);
                currentLayer = null;
            }
        }

        // è§’åº¦è¨ˆç®—é–¢æ•°
        function calculateAngle(from, to) {
            const dx = to[1] - from[1];
            const dy = to[0] - from[0];
            return Math.atan2(dy, dx) * 180 / Math.PI;
        }

        // æµã‚Œã‚‹ç‚¹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        function createFlowingDots(start, mid, end, color, layer, index, weight) {
            if (!animationEnabled) return;
            
            const dots = [];
            const numDots = Math.min(Math.max(2, Math.floor(weight / 2)), 4); // ç‚¹ã®æ•°ã‚’åˆ¶é™
            const dotSize = Math.max(6, Math.min(weight, 12)); // ã‚µã‚¤ã‚ºã‚’åˆ¶é™
            
            for (let i = 0; i < numDots; i++) {
                const dotIcon = L.divIcon({
                    html: `<div class="optimized-dot" style="
                        width: ${dotSize}px;
                        height: ${dotSize}px;
                        background: ${color};
                        border: 1px solid white;
                        border-radius: 50%;
                        box-shadow: 0 0 8px ${color}66;
                        position: relative;
                    ">
                        <div style="
                            width: ${Math.max(2, dotSize/4)}px;
                            height: ${Math.max(2, dotSize/4)}px;
                            background: white;
                            border-radius: 50%;
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                        "></div>
                    </div>`,
                    className: 'optimized-flowing-dot',
                    iconSize: [dotSize + 2, dotSize + 2],
                    iconAnchor: [dotSize/2 + 1, dotSize/2 + 1]
                });
                
                const dot = L.marker(start, { icon: dotIcon }).addTo(layer);
                dots.push(dot);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹ã‚’æœ€é©åŒ–
                setTimeout(() => {
                    animateDotOptimized(dot, start, mid, end, 3000 + (index % 3) * 500, i * 600);
                }, i * 400);
            }
        }

        // æœ€é©åŒ–ã•ã‚ŒãŸç‚¹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateDotOptimized(marker, start, mid, end, duration, delay) {
            let startTime = null;
            let animationId = null;
            
            function animate(timestamp) {
                if (!animationEnabled) return; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒåœæ­¢ã•ã‚ŒãŸå ´åˆã¯çµ‚äº†
                
                if (!startTime) startTime = timestamp + delay;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                if (progress >= 0 && progress <= 1) {
                    // æœ€é©åŒ–ã•ã‚ŒãŸãƒ™ã‚¸ã‚¨æ›²ç·šã§æ»‘ã‚‰ã‹ãªç§»å‹•
                    const t = progress;
                    const t2 = t * t;
                    const t1 = 1 - t;
                    const t1_2 = t1 * t1;
                    
                    const x = t1_2 * start[0] + 2 * t1 * t * mid[0] + t2 * end[0];
                    const y = t1_2 * start[1] + 2 * t1 * t * mid[1] + t2 * end[1];
                    
                    marker.setLatLng([x, y]);
                }
                
                if (progress < 1) {
                    animationId = requestAnimationFrame(animate);
                } else {
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã€é©åº¦ãªé…å»¶ã§ç¹°ã‚Šè¿”ã—
                    const restartDelay = 800 + Math.random() * 400; // ãƒ©ãƒ³ãƒ€ãƒ ãªé…å»¶ã§è‡ªç„¶ãªå‹•ã
                    setTimeout(() => {
                        if (animationEnabled) {
                            animateDotOptimized(marker, start, mid, end, duration, 0);
                        }
                    }, restartDelay);
                }
            }
            
            animationId = requestAnimationFrame(animate);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³IDã‚’ãƒãƒ¼ã‚«ãƒ¼ã«ä¿å­˜ï¼ˆå¾Œã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã‚‹ã‚ˆã†ã«ï¼‰
            marker._animationId = animationId;
        }

        // CSS for enhanced animations
        const style = document.createElement('style');
        style.textContent = `
            .flow-arrow {
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                z-index: 1000;
            }
            
            .flowing-dot {
                z-index: 999;
            }
            
            .start-marker, .end-marker {
                z-index: 1001;
            }
            
            @keyframes megaPulse {
                0%, 100% { 
                    transform: scale(1);
                    opacity: 1;
                }
                50% { 
                    transform: scale(1.4);
                    opacity: 0.7;
                }
            }
            
            /* æœ€é©åŒ–ã•ã‚ŒãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            .optimized-dot {
                transition: transform 0.2s ease-out;
            }
            
            .optimized-flowing-dot {
                will-change: transform;
                backface-visibility: hidden;
                transform: translateZ(0);
            }
            
            @keyframes arrowPulse {
                0%, 100% { 
                    transform: scale(1) rotate(var(--rotation, 0deg));
                    opacity: 1;
                }
                50% { 
                    transform: scale(1.3) rotate(var(--rotation, 0deg));
                    opacity: 0.8;
                }
            }
            
            @keyframes startPulse {
                0%, 100% { 
                    transform: scale(1);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                }
                50% { 
                    transform: scale(1.2);
                    box-shadow: 0 6px 20px rgba(0,0,0,0.7);
                }
            }
            
            @keyframes endPulse {
                0%, 100% { 
                    transform: scale(1);
                    box-shadow: 0 6px 16px rgba(0,0,0,0.6);
                }
                50% { 
                    transform: scale(1.15);
                    box-shadow: 0 8px 24px rgba(0,0,0,0.8);
                }
            }
            
            @keyframes numberPulse {
                0%, 100% { 
                    transform: scale(1);
                    opacity: 1;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
                }
                33% { 
                    transform: scale(1.1);
                    opacity: 0.9;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
                }
                66% { 
                    transform: scale(1.05);
                    opacity: 0.95;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.55);
                }
            }
            
            .flow-line {
                filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));
            }
            
            .leaflet-popup-content {
                border-radius: 8px !important;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
            }
        `;
        document.head.appendChild(style);

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        let animationEnabled = true;
        let currentAnimations = [];
        
        function toggleAnimation() {
            animationEnabled = !animationEnabled;
            const toggleText = document.getElementById('animToggleText');
            
            if (animationEnabled) {
                toggleText.innerHTML = 'â¸ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢<br><span style="font-size: 0.8em; opacity: 0.8;">Stop Animation</span>';
                showCommuteFlow(); // å†æç”»
            } else {
                toggleText.innerHTML = 'â–¶ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹<br><span style="font-size: 0.8em; opacity: 0.8;">Start Animation</span>';
                // å®Ÿè¡Œä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
                stopAllAnimations();
                clearLayer();
                showStaticFlow();
            }
        }
        
        function stopAllAnimations() {
            // å®Ÿè¡Œä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦åœæ­¢
            currentAnimations.forEach(id => {
                if (id) cancelAnimationFrame(id);
            });
            currentAnimations = [];
        }
        
        function resetView() {
            map.setView(commuteData.center, commuteData.zoom);
        }
        
        function showStaticFlow() {
            const flowLayer = L.layerGroup();
            
            // é™çš„è¡¨ç¤ºã§ã¯ inflowData ã‚’ä½¿ç”¨
            commuteData.inflowData.forEach((flow, index) => {
                const volume = flow.volume;
                let color, weight;
                
                if (volume >= 40000) {
                    color = '#ef4444';
                    weight = 6;
                } else if (volume >= 30000) {
                    color = '#f97316';
                    weight = 4;
                } else if (volume >= 20000) {
                    color = '#eab308';
                    weight = 3;
                } else {
                    color = '#22c55e';
                    weight = 2;
                }
                
                // åˆ°ç€åœ°ã®åº§æ¨™ã‚’å–å¾—
                const toArea = commuteData.mainAreas.find(area => area.name === flow.toArea);
                if (!toArea) return;
                
                // ã‚·ãƒ³ãƒ—ãƒ«ãªç›´ç·š
                const line = L.polyline([flow.from, toArea.center], {
                    color: color,
                    weight: weight,
                    opacity: 0.8
                }).addTo(flowLayer);
                
                // æ–¹å‘ã‚’ç¤ºã™çŸ¢å°
                const angle = calculateAngle(flow.from, toArea.center);
                const arrowIcon = L.divIcon({
                    html: `<div style="
                        transform: rotate(${angle}deg);
                        font-size: ${Math.max(14, weight + 2)}px;
                        color: ${color};
                        font-weight: bold;
                        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
                    ">â†’</div>`,
                    className: 'static-arrow',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                L.marker(toArea.center, { icon: arrowIcon }).addTo(flowLayer);
                
                // å‡ºç™ºåœ°ãƒãƒ¼ã‚«ãƒ¼
                const startIcon = L.divIcon({
                    html: `<div style="
                        background: ${color};
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    "></div>`,
                    className: 'static-start-marker',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                
                L.marker(flow.from, { icon: startIcon }).addTo(flowLayer);
                
                line.bindPopup(`
                    <div style="text-align: center; padding: 10px; min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: ${color};">
                            ${flow.fromName} â†’ ${flow.toArea}
                        </h3>
                        <div style="background: ${color}; color: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="font-size: 1.4em; font-weight: bold;">
                                ${flow.volume.toLocaleString()}äºº/æ—¥
                            </div>
                            <div style="font-size: 0.9em; opacity: 0.9;">
                                ${flow.volume.toLocaleString()} people/day
                            </div>
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            ${volume >= 40000 ? 'ğŸ”¥ è¶…å¤§è¦æ¨¡æµå…¥ | Ultra-large Flow' : 
                              volume >= 30000 ? 'ğŸ”´ å¤§è¦æ¨¡æµå…¥ | Large Flow' : 
                              volume >= 20000 ? 'ğŸŸ¡ ä¸­è¦æ¨¡æµå…¥ | Medium Flow' : 'ğŸŸ¢ å°è¦æ¨¡æµå…¥ | Small Flow'}
                        </div>
                    </div>
                `);
            });
            
            // ä¸»è¦å—ã‘å…¥ã‚Œã‚¨ãƒªã‚¢ã‚’ç°¡ç´ ãªå††ã§è¡¨ç¤º
            commuteData.mainAreas.forEach(area => {
                const radius = Math.sqrt(area.totalInflow) * 8; // é™çš„è¡¨ç¤ºã§ã¯å°ã•ã‚
                let color;
                
                if (area.totalInflow >= 300000) color = '#ef4444';
                else if (area.totalInflow >= 200000) color = '#f97316';
                else if (area.totalInflow >= 100000) color = '#eab308';
                else color = '#22c55e';
                
                const circle = L.circle(area.center, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.2,
                    radius: radius,
                    weight: 2
                }).addTo(flowLayer);
                
                circle.bindPopup(`
                    <div style="text-align: center; padding: 8px;">
                        <h3 style="margin: 0 0 8px 0; color: ${color};">ğŸ¢ ${area.name}</h3>
                        <div style="background: ${color}; color: white; padding: 8px; border-radius: 6px;">
                            <div style="font-size: 1.2em; font-weight: bold;">
                                ${(area.totalInflow / 10000).toFixed(1)}ä¸‡äºº
                            </div>
                            <div style="font-size: 0.9em; opacity: 0.9;">
                                æ¯æ—¥ã®æµå…¥äººå£ | Daily Inflow
                            </div>
                        </div>
                    </div>
                `);
            });
            
            currentLayer = flowLayer;
            flowLayer.addTo(map);
        }

        // åœ°å›³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupKeyboardNavigation();
        });
        
        function setupKeyboardNavigation() {
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });
        }
    </script>
</body>
</html>